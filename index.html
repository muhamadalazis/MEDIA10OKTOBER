<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petualangan 3D Bersama Alkana!</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #4a9cff;
            --secondary-color: #ff6b6b;
            --background-dark: linear-gradient(135deg, #1a2a6c, #2d5a8c, #4a90c7);
            --background-light: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            --text-dark: #333;
            --text-light: #fff;
        }

        body {
            background: var(--background-dark);
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }

        body.light-theme {
            background: var(--background-light);
            color: var(--text-dark);
        }

        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .points-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 100;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            background: var(--secondary-color);
            border-radius: 15px;
            font-size: 0.8em;
            margin: 5px;
            animation: bounce 0.5s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(90deg, rgba(255,107,107,0.08), rgba(74,156,255,0.08));
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            animation: fadeIn 1s ease-out;
        }

        h1 {
            font-size: 2.5rem;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #4a9cff;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .nav-btn:hover {
            background: #4a9cff;
            transform: translateY(-3px);
        }

        .nav-btn.active {
            background: #ff6b6b;
            border-color: #ff6b6b;
        }

        .content-section {
            display: none;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            animation: slideIn 0.5s ease-out;
        }

        .content-section.active {
            display: block;
        }

        .section-title {
            margin-bottom: 20px;
            border-bottom: 2px solid #ffcc00;
            padding-bottom: 10px;
            color: #ffcc00;
        }

        .visualization-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }

        .tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
            pointer-events: none;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-30px);}
            60% {transform: translateY(-15px);}
        }

        .quiz-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .quiz-option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiz-option:hover {
            background: rgba(74, 156, 255, 0.2);
        }

        .quiz-option.correct {
            background: rgba(46, 213, 115, 0.2);
            border-color: #2ed573;
        }

        .quiz-option.incorrect {
            background: rgba(255, 71, 87, 0.2);
            border-color: #ff4757;
        }

        .molecule-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .molecule-card:hover {
            transform: translateY(-5px) rotateY(10deg);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .achievement-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(46, 213, 115, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            animation: slideIn 0.5s ease-out;
            z-index: 1000;
        }

        .interactive-button {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .interactive-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .interactive-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2));
            transform: translateX(-100%);
            transition: 0.3s;
        }

        .interactive-button:hover::after {
            transform: translateX(100%);
        }

        .floating-help {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--primary-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .floating-help:hover {
            transform: scale(1.1);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--primary-color);
            animation: confetti-fall 3s ease-in-out infinite;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100%) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .molecule-viewer {
            flex: 1;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        #molecule-container {
            width: 100%;
            height: 350px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .molecule-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .control-btn {
            padding: 8px 12px;
            background: linear-gradient(90deg,#4a9cff,#6dd5fa);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .control-btn:hover {
            background: #2d7ad6;
            transform: translateY(-2px);
        }

        .atom-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .color-box {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }

        .carbon-color {
            background-color: #333333;
        }

        .hydrogen-color {
            background-color: #ffffff;
        }

        .info-panel {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
        }

        .alkane-info {
            margin-bottom: 20px;
        }

        .alkane-info h3 {
            color: #ffcc00;
            margin-bottom: 10px;
        }

        .formula-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2rem;
        }

        .prefix-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .prefix-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .prefix-item:hover {
            background: rgba(74, 156, 255, 0.3);
            transform: translateY(-3px);
        }

        .prefix-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffcc00;
        }

        .prefix-name {
            font-size: 1rem;
            margin-top: 5px;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 18px rgba(0,0,0,0.35);
            border-left: 6px solid rgba(74,156,255,0.18);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }
        .game-container:hover { transform: translateY(-6px); box-shadow: 0 18px 30px rgba(0,0,0,0.45); }

        /* Game lobby / round cards */
        .game-lobby {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 18px;
            flex-wrap: wrap;
        }
        .round-card {
            width: 260px;
            padding: 16px;
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
            box-shadow: 0 8px 20px rgba(0,0,0,0.45);
            cursor: pointer;
            transition: transform 0.25s ease, box-shadow 0.25s ease, border 0.25s ease;
            border: 2px solid transparent;
        }
        .round-card:hover { transform: translateY(-8px) scale(1.02); border-color: rgba(74,156,255,0.22); }
        .round-card .rc-title { font-weight: bold; font-size: 1.05rem; margin-bottom: 8px; color: #ffd; }
        .round-card .rc-desc { font-size: 0.95rem; color: #ddd; margin-bottom:12px; }
        .round-card .rc-progress { height:10px; background: rgba(255,255,255,0.06); border-radius:6px; overflow:hidden; }
        .round-card .rc-fill { height:100%; width:0%; background: linear-gradient(90deg,#4a9cff,#ff6b6b); transition: width 0.5s ease; }

        .hint-box { background: rgba(0,0,0,0.45); padding:8px; border-radius:6px; margin-top:8px; display:none; }
        .timer-bubble { display:inline-block; padding:6px 8px; background: rgba(255,255,255,0.06); border-radius:20px; margin-left:8px; font-weight:bold; }

        .game-question {
            font-size: 1.2rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .game-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .game-option {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .game-option:hover {
            background: rgba(74, 156, 255, 0.3);
        }

        .game-option.correct {
            background: rgba(76, 175, 80, 0.5);
        }

        .game-option.incorrect {
            background: rgba(244, 67, 54, 0.5);
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .game-btn {
            padding: 10px 20px;
            background: #4a9cff;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .game-btn:hover {
            background: #2d7ad6;
            transform: translateY(-2px);
        }

        .game-btn.next {
            background: #ff6b6b;
        }

        .game-btn.next:hover {
            background: #e05555;
        }

        .game-progress {
            margin-top: 20px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #4a9cff, #ff6b6b);
            width: 0%;
            transition: width 0.5s ease;
        }

        .reflection-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .reflection-question {
            margin-bottom: 15px;
        }

        .reflection-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #4a9cff;
            border-radius: 5px;
            padding: 10px;
            color: white;
            margin-bottom: 15px;
            min-height: 80px;
        }

        .diagram-2d {
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.02), 0 6px 12px rgba(0,0,0,0.22);
        }

        /* Prediction / discovery UI */
        .prediction-row { display:flex; gap:8px; margin-top:10px; align-items:center; }
        .prediction-input { flex:1; padding:8px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.2); color:inherit; }
        .small-hint { font-size:0.9rem; color: #ffd; opacity:0.9; margin-top:6px; }
    /* Investigation panel tweaks */
    #investigation-panel h3 { font-size:1.05rem; margin-bottom:6px; }
    #investigation-panel .control-btn, #investigation-panel .game-btn { font-weight:bold; }

        .certificate {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            border-radius: 15px;
            margin-top: 30px;
            display: none;
        }

        .certificate.active {
            display: block;
            animation: zoomIn 0.8s ease-out;
        }

        .certificate h2 {
            color: #ffcc00;
            margin-bottom: 20px;
        }

        .certificate p {
            margin-bottom: 15px;
        }

        .student-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffcc00;
            margin: 20px 0;
        }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            .visualization-container {
                flex-direction: column;
            }
            
            .navigation {
                flex-direction: column;
            }
            
            .game-options {
                grid-template-columns: 1fr;
            }
        }
        /* Label sprites for atom groups (CH3, CH2) */
        .label-sprite {
            pointer-events: none;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            padding: 4px 8px;
            border-radius: 6px;
            background: linear-gradient(90deg, rgba(0,0,0,0.6), rgba(0,0,0,0.35));
        }

        /* Feedback visuals for answers */
        .feedback {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
            font-size: 1.05rem;
        }

        .feedback.correct {
            color: #a5d6a7; /* light green */
        }

        .feedback.incorrect {
            color: #ef9a9a; /* light red */
        }

        /* Animations for correct / incorrect feedback */
        .animate-correct {
            animation: pop 0.6s ease forwards;
            box-shadow: 0 8px 30px rgba(46,213,115,0.18);
        }

        .animate-wrong {
            animation: shake 0.6s ease forwards;
            box-shadow: 0 8px 30px rgba(255,71,87,0.12);
        }

        .game-option.selected.correct {
            animation: correctPulse 0.9s ease-out;
            transform-origin: center;
        }

        .game-option.selected.incorrect {
            animation: wrongShake 0.7s ease-out;
        }

        @keyframes pop {
            0% { transform: scale(0.92); opacity: 0.9; }
            50% { transform: scale(1.06); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            20% { transform: translateX(-8px) rotate(-2deg); }
            40% { transform: translateX(8px) rotate(2deg); }
            60% { transform: translateX(-6px) rotate(-1deg); }
            80% { transform: translateX(4px) rotate(1deg); }
            100% { transform: translateX(0); }
        }

        @keyframes correctPulse {
            0% { box-shadow: 0 0 0 rgba(46,213,115,0); }
            50% { box-shadow: 0 0 22px rgba(46,213,115,0.35); }
            100% { box-shadow: 0 0 0 rgba(46,213,115,0); }
        }

        @keyframes wrongShake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-6px); }
            50% { transform: translateX(6px); }
            75% { transform: translateX(-4px); }
            100% { transform: translateX(0); }
        }

        .feedback .icon {
            font-size: 1.6rem;
        }

        /* Atom tooltip */
        .atom-tooltip {
            position: absolute;
            pointer-events: none;
            background: rgba(0,0,0,0.75);
            color: #fff;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 13px;
            transform: translate(-50%, -120%);
            display: none;
            z-index: 1000;
            white-space: nowrap;
            box-shadow: 0 6px 18px rgba(0,0,0,0.5);
        }

        /* 2D diagram box */
        .diagram-2d {
            width: 220px;
            height: 80px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 8px;
            padding: 6px;
            display: inline-block;
            vertical-align: middle;
            margin-left: 12px;
        }

        /* Debug panel */
        .debug-panel {
            position: fixed;
            right: 12px;
            top: 12px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 2000;
            max-width: 320px;
            max-height: 200px;
            overflow: auto;
        }
        /* Atom info panel */
        .atom-info {
            margin-top: 12px;
            padding: 10px;
            background: rgba(0,0,0,0.45);
            border-radius: 8px;
            box-shadow: 0 8px 18px rgba(0,0,0,0.4);
        }

        /* Confetti overlay (simple) */
        #confetti-canvas {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3000;
        }
        @keyframes hueShift { 0% { filter: hue-rotate(0deg);} 50% { filter: hue-rotate(45deg);} 100% { filter: hue-rotate(0deg);} }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1;} 50% { transform: scale(1.05); opacity: 0.9;} 100% { transform: scale(1); opacity: 1;} }
        
        /* Tutorial and Investigation Tool Styles */
        .tool-btn {
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tool-btn:hover {
            background: rgba(74, 156, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .tool-btn.active {
            background: rgba(74, 156, 255, 0.3);
            box-shadow: 0 0 10px rgba(74, 156, 255, 0.3);
        }
        
        #tutorial-panel {
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .highlight {
            position: relative;
        }
        
        .highlight::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 12px;
            border: 2px solid rgba(74, 156, 255, 0.5);
            animation: pulse 2s infinite;
            pointer-events: none;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
</head>
<body>
    <div id="particles-js"></div>
    <div class="progress-container">
        <div class="progress-bar"></div>
    </div>
    <div class="points-display">
        Poin: <span id="points">0</span>
        <div id="badges"></div>
    </div>
    <div id="investigation-panel" style="display:none; position:fixed; left:20px; top:100px; width:380px; background:rgba(0,0,0,0.75); color:#fff; padding:20px; border-radius:15px; z-index:1500; box-shadow:0 12px 30px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.1);">
        <h3 style="margin-top:0; color:#4a9cff; font-size:1.2rem;">üî¨ Jurnal Penelitian Alkana</h3>
        <div class="investigation-progress" style="margin:8px 0 12px; background:rgba(255,255,255,0.1); height:4px; border-radius:2px;">
            <div id="investigation-progress-bar" style="width:0%; height:100%; background:linear-gradient(90deg,#4a9cff,#ff6b6b); transition:width 0.3s ease;"></div>
        </div>
        <div class="research-stages" style="margin-bottom:12px;">
            <div class="stage" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:8px;">
                <h4 style="margin:0 0 5px; color:#4a9cff;">ÔøΩ Tahap 1: Pengamatan Awal</h4>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem;">
                    <li>Amati bentuk molekul pertama</li>
                    <li>Hitung jumlah atom C dan H</li>
                    <li>Catat bagaimana atom-atom terhubung</li>
                </ul>
            </div>
            <div class="stage" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:8px;">
                <h4 style="margin:0 0 5px; color:#4a9cff;">üîç Tahap 2: Eksperimen</h4>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem;">
                    <li>Coba tambah/kurangi atom C</li>
                    <li>Amati perubahan jumlah H</li>
                    <li>Catat setiap pola yang kamu temukan</li>
                </ul>
            </div>
            <div class="stage" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
                <h4 style="margin:0 0 5px; color:#4a9cff;">üí° Tahap 3: Kesimpulan</h4>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem;">
                    <li>Temukan hubungan jumlah C dan H</li>
                    <li>Rumuskan teori kamu</li>
                    <li>Uji dengan molekul baru</li>
                </ul>
            </div>
        </div>
        <div id="discovery-lab" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin:12px 0;">
            <h4 style="margin:0 0 10px; color:#4a9cff;">üìä Tabel Pengamatan</h4>
            <div class="observation-table" style="width:100%; margin-bottom:12px;">
                <table style="width:100%; border-collapse:collapse; font-family:monospace; font-size:0.9rem;">
                    <thead>
                        <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                            <th style="padding:8px; text-align:center">Jumlah C</th>
                            <th style="padding:8px; text-align:center">Jumlah H</th>
                            <th style="padding:8px; text-align:center">Catatan</th>
                        </tr>
                    </thead>
                    <tbody id="observation-data">
                        <!-- Data will be added here dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div class="discovery-tools" style="display:flex; gap:8px; flex-wrap:wrap;">
                <button id="record-observation-btn" class="control-btn" style="flex:1; font-size:0.95rem;">üì∏ Catat Data</button>
                <button id="analyze-pattern-btn" class="control-btn" style="flex:1; font-size:0.95rem;">üîç Analisis Pola</button>
                <button id="make-prediction-btn" class="control-btn" style="flex:1; font-size:0.95rem;">üéØ Buat Prediksi</button>
            </div>
            
            <div id="pattern-hints" style="margin-top:12px; padding:10px; background:rgba(74,156,255,0.1); border-radius:8px; display:none;">
                <p style="margin:0; font-size:0.9rem; color:#fff;">
                    <span style="color:#4a9cff;">üí° Petunjuk:</span> 
                    <span id="current-hint">Amati perubahan jumlah H saat jumlah C bertambah...</span>
                </p>
            </div>
        </div>
        
        <div id="student-theory" style="margin-top:12px; padding:15px; background:rgba(255,255,255,0.05); border-radius:10px;">
            <h4 style="margin:0 0 10px; color:#4a9cff;">üåü Teori Kamu</h4>
            <textarea id="theory-notes" style="width:100%; height:60px; background:rgba(255,255,255,0.1); border:none; border-radius:8px; padding:8px; color:#fff; margin-bottom:8px;" placeholder="Tulis teori kamu tentang hubungan jumlah atom C dan H di sini..."></textarea>
            <button id="submit-theory" class="game-btn" style="width:100%;">‚ú® Ajukan Teori</button>
        </div>
        <button id="conclude-investigation" class="game-btn" style="width:100%; margin-top:4px; font-size:1rem;">‚ú® Simpulkan Temuan Saya</button>
        
        <div id="investigation-tools" style="margin-top:12px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.1);">
            <h4 style="margin:0 0 8px; color:#4a9cff;">üîß Alat Lab Alkana</h4>
            
            <div class="tool-description" style="margin-bottom:12px; font-size:0.9rem; color:#aaa;">
                Gunakan alat-alat canggih ini untuk mengamati molekul lebih detail!
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <div class="tool-card" style="background:rgba(255,255,255,0.05); padding:12px; border-radius:10px; transition:all 0.3s ease;">
                    <button class="tool-btn" style="width:100%; padding:8px; background:rgba(74,156,255,0.1); border:none; color:#fff; border-radius:8px; cursor:pointer; margin-bottom:8px;" onclick="toggleMeasurements()">
                        ÔøΩ Ukur Sudut
                    </button>
                    <div class="tool-info" style="font-size:0.8rem; color:#aaa;">
                        Mengukur sudut ikatan antar atom. Klik dua atom untuk mengukur sudut.
                    </div>
                </div>
                
                <div class="tool-card" style="background:rgba(255,255,255,0.05); padding:12px; border-radius:10px; transition:all 0.3s ease;">
                    <button class="tool-btn" style="width:100%; padding:8px; background:rgba(74,156,255,0.1); border:none; color:#fff; border-radius:8px; cursor:pointer; margin-bottom:8px;" onclick="toggleBondLength()">
                        üìè Panjang Ikatan
                    </button>
                    <div class="tool-info" style="font-size:0.8rem; color:#aaa;">
                        Mengukur jarak antar atom yang berikatan. Klik dua atom.
                    </div>
                </div>
                
                <div class="tool-card" style="background:rgba(255,255,255,0.05); padding:12px; border-radius:10px; transition:all 0.3s ease;">
                    <button class="tool-btn" style="width:100%; padding:8px; background:rgba(74,156,255,0.1); border:none; color:#fff; border-radius:8px; cursor:pointer; margin-bottom:8px;" onclick="showElectrons()">
                        ‚ö° Lihat Elektron
                    </button>
                    <div class="tool-info" style="font-size:0.8rem; color:#aaa;">
                        Menampilkan persebaran elektron dalam molekul.
                    </div>
                </div>
                
                <div class="tool-card" style="background:rgba(255,255,255,0.05); padding:12px; border-radius:10px; transition:all 0.3s ease;">
                    <button class="tool-btn" style="width:100%; padding:8px; background:rgba(74,156,255,0.1); border:none; color:#fff; border-radius:8px; cursor:pointer; margin-bottom:8px;" onclick="toggleLabels()">
                        üè∑Ô∏è Label Atom
                    </button>
                    <div class="tool-info" style="font-size:0.8rem; color:#aaa;">
                        Menampilkan nama dan nomor setiap atom.
                    </div>
                </div>
            </div>

            <div class="tool-tips" style="margin-top:12px; padding:10px; background:rgba(74,156,255,0.1); border-radius:8px;">
                <p style="margin:0; font-size:0.9rem;">
                    üí° <strong>Tips Lab:</strong> 
                    <span id="current-tool-tip">Gunakan kombinasi alat untuk pengamatan lebih lengkap!</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Tutorial Panel -->
    <div id="tutorial-panel" style="display:none; position:fixed; right:20px; top:100px; width:340px; background:rgba(0,0,0,0.75); color:#fff; padding:20px; border-radius:15px; z-index:1500; box-shadow:0 12px 30px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.1);">
        <h3 style="margin:0; color:#4a9cff;">üéì Tutorial Interaktif</h3>
        <div id="tutorial-progress" style="margin:8px 0 12px; background:rgba(255,255,255,0.1); height:4px; border-radius:2px;">
            <div id="tutorial-progress-bar" style="width:0%; height:100%; background:linear-gradient(90deg,#4a9cff,#ff6b6b); transition:width 0.3s ease;"></div>
        </div>
        <div id="tutorial-content" style="margin:12px 0; min-height:120px;">
            <!-- Tutorial content will be dynamically updated -->
        </div>
        <div style="display:flex; gap:8px; margin-top:12px;">
            <button id="prev-tutorial" class="control-btn" style="flex:1;" onclick="prevTutorialStep()">‚¨ÖÔ∏è Sebelumnya</button>
            <button id="next-tutorial" class="control-btn" style="flex:1;" onclick="nextTutorialStep()">Selanjutnya ‚û°Ô∏è</button>
        </div>
    </div>

    <div class="theme-toggle">
        <button id="themeToggle" class="nav-btn">
            <i class="fas fa-moon"></i> Ganti Tema
        </button>
    </div>
    <div class="floating-help">
        <i class="fas fa-question"></i>
    </div>
    <div class="container">
        <div class="quick-actions">
            <button class="interactive-button" onclick="startTutorial()">
                <i class="fas fa-play"></i> Tutorial Interaktif
            </button>
            <button class="interactive-button" onclick="showMoleculeGallery()">
                <i class="fas fa-atom"></i> Galeri Molekul
            </button>
            <button class="interactive-button" onclick="startChallenge()">
                <i class="fas fa-trophy"></i> Tantangan Harian
            </button>
            <button class="interactive-button" onclick="openMysteryBox()">
                <i class="fas fa-gift"></i> Kotak Misteri
            </button>
            <button class="interactive-button" onclick="startInvestigation()">
                <i class="fas fa-search"></i> Mulai Investigasi
            </button>
        </div>
        <header>
            <h1>Petualangan Alkana Bersama Alki! üî¨</h1>
            <p class="subtitle">Mari Jelajahi dan Temukan Rahasia Alkana Bersama-sama!</p>
            <div class="mascot-intro" style="text-align:center; margin:15px 0;">
                <img src="https://via.placeholder.com/100" alt="Alki Maskot" style="border-radius:50%; border:3px solid #4a9cff;" id="alki-mascot">
                <p style="font-size:1.1rem; margin-top:10px;">
                    "Hai! Aku Alki, akan menemani petualanganmu menemukan rahasia Alkana! üåü"
                </p>
            </div>
        </header>

        <div class="navigation">
            <button class="nav-btn active" data-section="intro">Pengenalan Alkana</button>
            <button class="nav-btn" data-section="naming">Tata Nama Alkana</button>
            <button class="nav-btn" data-section="simulation">Simulasi 3D</button>
            <button class="nav-btn" data-section="game">Permainan Alkana</button>
            <button class="nav-btn" data-section="reflection">Refleksi</button>
            <button class="nav-btn" id="open-game-quick">Buka Permainan</button>
        </div>

        <div class="debug-panel" id="debug-panel" style="display:none;"></div>

        <!-- Bagian 1: Mulai Petualangan -->
        <section id="intro" class="content-section active">
            <h2 class="section-title">Mari Mulai Petualangan! üöÄ</h2>
            
            <div class="discovery-intro" style="text-align:center; margin-bottom:20px;">
                <div style="background:rgba(74,156,255,0.1); padding:20px; border-radius:15px; margin:15px 0;">
                    <h3 style="color:#4a9cff; margin-bottom:15px;">Misi Investigasi Alkana üîç</h3>
                    <p style="font-size:1.1rem; line-height:1.6;">
                        Sebagai ilmuwan muda, kamu akan:
                        <br>‚Ä¢ Mengamati berbagai molekul misterius
                        <br>‚Ä¢ Mencatat pola-pola yang kamu temukan
                        <br>‚Ä¢ Merumuskan teorimu sendiri
                        <br>‚Ä¢ Membuktikan temuanmu!
                    </p>
                </div>
            </div>

            <div class="visualization-container">
                <div class="molecule-viewer">
                    <div id="molecule-container"></div>
                    <div class="molecule-guide" style="text-align:center; margin:10px 0; padding:10px; background:rgba(0,0,0,0.05); border-radius:10px;">
                        <p style="font-size:0.9rem; color:#666;">
                            üí° Tips: Putar dan amati molekul dari berbagai sudut untuk menemukan polanya!
                        </p>
                    </div>
                    <div class="molecule-controls">
                <button class="control-btn" id="add-carbon">Tambah 1 Atom C</button>
                <button class="control-btn" id="remove-carbon">Kurangi 1 Atom C</button>
                <button class="control-btn" id="reset-molecule">Reset ke Metana</button>
                <button class="control-btn" id="toggle-autorotate">Toggle Auto-Rotate</button>
                <button class="control-btn" id="focus-molecule">Fokus Molekul</button>
                        <div id="preset-buttons" style="margin-left:8px; display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                            <button class="control-btn" id="preset-methane">Metana</button>
                            <button class="control-btn" id="preset-pentane">Pentana</button>
                            <button class="control-btn" id="preset-2methylbutane">2‚ÄëMetilbutana</button>
                            <button class="control-btn" id="preset-2,3-dimethylpentane">2,3‚ÄëDimetilpentana</button>
                            <button class="control-btn" id="toggle-melody">Melodi: OFF</button>
                        </div>
                    </div>
                    <div class="atom-legend">
                        <div class="legend-item">
                            <div class="color-box carbon-color"></div>
                            <span>Karbon (C)</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box hydrogen-color"></div>
                            <span>Hidrogen (H)</span>
                        </div>
                    </div>
                </div>
                <div class="info-panel">
                    <div class="alkane-info">
                        <h3 id="alkane-name">Metana (CH‚ÇÑ)</h3>
                        <p id="alkane-description">Alkana adalah hidrokarbon jenuh yang hanya memiliki ikatan tunggal (C‚ÄìC). Metana adalah alkana paling sederhana dengan satu atom karbon dan empat atom hidrogen.</p>
                        <div class="formula-box">
                            <p>Rumus Molekul: <span id="molecular-formula">CH‚ÇÑ</span></p>
                            <p class="discovery-prompt">Mari temukan pola hubungan antara jumlah atom C dan H! üîç</p>
                        </div>
                        <div class="atom-info" id="atom-info">
                            <strong>Info Atom</strong>
                            <p id="atom-info-text">Klik sebuah atom pada tampilan 3D untuk melihat detail (C = karbon, H = hidrogen).</p>
                            <div style="margin-top:8px; display:flex; gap:8px;"><button class="control-btn" id="atom-quiz-btn">Cek Quiz</button><button class="control-btn" id="atom-unpin">Tutup</button></div>
                        </div>
                    </div>
                    <div class="alkane-info">
                        <h3>Pola Perubahan Struktur</h3>
                        <p>Setiap penambahan satu atom karbon (C) akan menambah dua atom hidrogen (H) dan satu metilena (-CH‚ÇÇ-) pada rantai.</p>
                        <p>Gunakan tombol di samping untuk menjelajahi perubahan struktur alkana!</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Bagian 2: Dasar Tata Nama Alkana -->
        <section id="naming" class="content-section">
            <h2 class="section-title">Dasar Tata Nama Alkana</h2>
            <div class="info-panel">
                <p>Alkana memiliki sistem penamaan berdasarkan jumlah atom karbon dalam rantai utamanya. Berikut adalah prefiks (awalan) yang digunakan:</p>
                
                <div class="prefix-grid">
                    <div class="prefix-item" data-prefix="meth">
                        <div class="prefix-number">1</div>
                        <div class="prefix-name">Met-</div>
                    </div>
                    <div class="prefix-item" data-prefix="eth">
                        <div class="prefix-number">2</div>
                        <div class="prefix-name">Et-</div>
                    </div>
                    <div class="prefix-item" data-prefix="prop">
                        <div class="prefix-number">3</div>
                        <div class="prefix-name">Prop-</div>
                    </div>
                    <div class="prefix-item" data-prefix="but">
                        <div class="prefix-number">4</div>
                        <div class="prefix-name">But-</div>
                    </div>
                    <div class="prefix-item" data-prefix="pent">
                        <div class="prefix-number">5</div>
                        <div class="prefix-name">Pent-</div>
                    </div>
                    <div class="prefix-item" data-prefix="hex">
                        <div class="prefix-number">6</div>
                        <div class="prefix-name">Heks-</div>
                    </div>
                    <div class="prefix-item" data-prefix="hept">
                        <div class="prefix-number">7</div>
                        <div class="prefix-name">Hept-</div>
                    </div>
                    <div class="prefix-item" data-prefix="oct">
                        <div class="prefix-number">8</div>
                        <div class="prefix-name">Okt-</div>
                    </div>
                </div>
                
                <div class="alkane-info" style="margin-top: 20px;">
                    <h3>Aturan Penamaan Alkana</h3>
                    <ul>
                        <li>Nama alkana terdiri dari <strong>prefiks</strong> (berdasarkan jumlah atom C) + <strong>akhiran -ana</strong></li>
                        <li>Contoh: Met- + ana = <strong>Metana</strong></li>
                        <li>Untuk alkana rantai lurus, tidak perlu penomoran</li>
                        <li>Untuk alkana rantai bercabang, perlu penomoran posisi cabang</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Bagian 3: Simulasi Ikatan 3D -->
        <section id="simulation" class="content-section">
            <h2 class="section-title">Simulasi Ikatan 3D</h2>
            <div class="visualization-container">
                <div class="molecule-viewer">
                    <div id="simulation-container"></div>
                    <div class="molecule-controls">
                        <button class="control-btn" id="show-bonds">Tampilkan Ikatan</button>
                        <button class="control-btn" id="hide-hydrogen">Sembunyikan Atom H</button>
                        <button class="control-btn" id="show-all">Tampilkan Semua</button>
                    </div>
                    <div class="atom-legend">
                        <div class="legend-item">
                            <div class="color-box carbon-color"></div>
                            <span>Karbon (C)</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box hydrogen-color"></div>
                            <span>Hidrogen (H)</span>
                        </div>
                    </div>
                </div>
                <div class="info-panel">
                    <div class="alkane-info">
                        <h3>Eksperimen dengan Struktur 3D</h3>
                        <p>Gunakan kontrol di samping untuk memanipulasi tampilan molekul:</p>
                        <ul>
                            <li><strong>Tampilkan Ikatan</strong> - Menyoroti ikatan tunggal C-C</li>
                            <li><strong>Sembunyikan Atom H</strong> - Hanya menampilkan rangka karbon</li>
                            <li><strong>Tampilkan Semua</strong> - Kembali ke tampilan normal</li>
                        </ul>
                        <p>Anda juga dapat menggunakan mouse untuk:
                            <ul>
                                <li>Memutar molekul - Kiri + gerakkan mouse</li>
                                <li>Memperbesar/memperkecil - Scroll mouse</li>
                                <li>Menggeser - Kanan + gerakkan mouse</li>
                            </ul>
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Bagian 4: Permainan Alkana -->
        <section id="game" class="content-section">
            <h2 class="section-title">Permainan: Tebak dan Rangkai Alkana!</h2>
            
                <div class="game-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="game-progress"></div>
                    </div>
                    <p>Ronde <span id="current-round">1</span> dari <span id="total-rounds">3</span></p>
                </div>

                <!-- Game structure: 3 rounds, each with 3 babak -->
                <div id="game-rounds-wrapper">
                    <!-- Ronde template will be populated by JS -->
                </div>

                <div class="reflection-section" id="game-conclusion" style="display: none;">
                    <h3>Kesimpulan Permainan</h3>
                    <div id="round-summaries"></div>
                    <p>Skor akhir kamu: <span id="final-score">0</span> dari <span id="total-questions">9</span></p>
                    <div id="conclusion-text" style="margin-top:12px;"></div>
                </div>
        </section>

        <!-- Bagian 5: Refleksi -->
        <section id="reflection" class="content-section">
            <h2 class="section-title">Refleksi Pembelajaran</h2>
            
            <div class="reflection-section">
                <div class="reflection-question">
                    <h3>1. Apa pola yang kamu temukan pada alkana rantai lurus?</h3>
                    <textarea class="reflection-input" placeholder="Tulis jawabanmu di sini..."></textarea>
                </div>
                
                <div class="reflection-question">
                    <h3>2. Bagaimana cara menentukan penomoran cabang pada alkana bercabang?</h3>
                    <textarea class="reflection-input" placeholder="Tulis jawabanmu di sini..."></textarea>
                </div>
                
                <div class="reflection-question">
                    <h3>3. Apa perbedaan struktur bercabang dan tidak bercabang?</h3>
                    <textarea class="reflection-input" placeholder="Tulis jawabanmu di sini..."></textarea>
                </div>
                
                <button class="game-btn" id="submit-reflection" style="width: 100%;">Submit Refleksi</button>
            </div>
            
            <div class="certificate" id="certificate">
                <h2>Sertifikat Eksplorator Alkana 3D</h2>
                <p>Diberikan kepada:</p>
                <div class="student-name" id="student-name">Nama Siswa</div>
                <p>Atas partisipasi aktif dalam Petualangan 3D Bersama Alkana!</p>
                <p>Telah berhasil menyelesaikan pembelajaran tentang struktur dan tata nama alkana.</p>
                <p>Skor: <span id="certificate-score">0</span>/3</p>
                <p>Selamat! Kamu sekarang adalah Eksplorator Alkana 3D!</p>
            </div>
        </section>

        <footer>
            <p>Media Pembelajaran Kimia - Petualangan 3D Bersama Alkana!</p>
        </footer>
    </div>

    <script>
    // Data alkana
        const alkanes = {
            methane: {
                name: "Metana",
                formula: "CH‚ÇÑ",
                description: "Alkana dengan satu atom karbon. Strukturnya tetrahedral dengan sudut ikatan 109.5¬∞.",
                carbonCount: 1
            },
            ethane: {
                name: "Etana",
                formula: "C‚ÇÇH‚ÇÜ",
                description: "Alkana dengan dua atom karbon dalam rantai lurus.",
                carbonCount: 2
            },
            propane: {
                name: "Propana",
                formula: "C‚ÇÉH‚Çà",
                description: "Alkana dengan tiga atom karbon dalam rantai lurus.",
                carbonCount: 3
            },
            butane: {
                name: "Butana",
                formula: "C‚ÇÑH‚ÇÅ‚ÇÄ",
                description: "Alkana dengan empat atom karbon dalam rantai lurus.",
                carbonCount: 4
            },
            pentane: {
                name: "Pentana",
                formula: "C‚ÇÖH‚ÇÅ‚ÇÇ",
                description: "Alkana dengan lima atom karbon dalam rantai lurus.",
                carbonCount: 5
            },
            hexane: {
                name: "Heksana",
                formula: "C‚ÇÜH‚ÇÅ‚ÇÑ",
                description: "Alkana dengan enam atom karbon dalam rantai lurus.",
                carbonCount: 6
            }
        };

        // Game questions: 3 rounds x 3 babak (9 questions)
        const gameQuestions = [
            // Ronde 1: straight-chain alkanes (identify from C and H counts)
            { round: 1, prompt: 'Molekul ini memiliki 3 atom C dan 8 atom H. Apa nama senyawanya?', choices: ['Metana','Propana','Butana','Etana'], answer: 'Propana', hint: 'Petunjuk: Perhatikan jumlah atom C. Nama senyawa terkait dengan jumlah atom C.' },
            { round: 1, prompt: 'Molekul ini memiliki 4 atom C dan 10 atom H. Apa nama senyawanya?', choices: ['Butana','Pentana','Etana','Propana'], answer: 'Butana', hint: '4 C -> but-' },
            { round: 1, prompt: 'Molekul ini memiliki 5 atom C dan 12 atom H. Apa nama senyawanya?', choices: ['Pentana','Heksana','Butana','Propana'], answer: 'Pentana', hint: '5 C -> pent-' },

            // Ronde 2: branched alkanes (positioning and naming)
            { round: 2, prompt: 'Pada 2-metilbutana, pada atom karbon berapa cabang metil berada?', choices: ['1','2','3','4'], answer: '2', hint: 'Penomoran dimulai dari ujung terdekat cabang' },
            { round: 2, prompt: 'Nama yang benar untuk struktur dengan rantai utama 5 C dan satu cabang metil pada C-3?', choices: ['3-metilpentana','2-metilpentana','metilpentana','pentametil'], answer: '3-metilpentana', hint: 'Nomor di depan nama cabang' },
            { round: 2, prompt: 'Jika ada satu cabang metil pada karbon kedua dari rantai 4 C, nama yang benar adalah?', choices: ['2-metilbutana','3-metilbutana','metilbutana','butametil'], answer: '2-metilbutana', hint: 'Butana = 4 C' },

            // Ronde 3: mixed (structure recognition)
            { round: 3, prompt: 'Manakah pilihan yang menggambarkan 3-metilpentana?', choices: ['Rantai lurus 5 C','Cabang metil di C-3','Cabang metil di C-2','Dua cabang metil'], answer: 'Cabang metil di C-3', hint: 'Perhatikan posisi angka' },
            { round: 3, prompt: 'Senyawa dengan formula C6H14 yang bukan rantai lurus adalah contoh?', choices: ['Heksana','2-metilpentana','Pentana','Propana'], answer: '2-metilpentana', hint: '6 C bisa bercabang' },
            { round: 3, prompt: 'Jika ada rantai 5 C dan dua cabang metil pada C-2 dan C-3, nama yang benar adalah?', choices: ['2,3-dimetilpentana','3,3-dimetilpentana','2-dimetilpentana','dimetilpentana'], answer: '2,3-dimetilpentana', hint: 'Gunakan koma untuk posisi, abjad untuk penamaan cabang' }
        ];

        // State for game
        let gameState = {
            currentRound: 1,
            currentBabakIndex: 0, // index within all questions
            answers: [], // {questionIndex, selected, correct}
            roundConclusions: {1: '', 2: '', 3: ''}
        };

        // interactivity tracking
        let atomMeshes = [];
        let bondMeshes = [];
        // simulation-specific tracking
        let simulationAtomMeshes = [];
        let simulationBondMeshes = [];
        let raycaster, mouse;

        // Variabel global untuk Three.js
        let scene, camera, renderer, controls;
        let simulationScene, simulationCamera, simulationRenderer, simulationControls;
        let currentMolecule = null;
        let currentCarbonCount = 1;
        let gameScore = 0;
        let currentRound = 1;
        let autoRotate = true;
    // performance / appearance constants
    const ATOM_SEGMENTS = 16; // lower for performance, still smooth
    const BOND_CYL_SEGMENTS = 12;

    // bond pulse animations
    let activeBondPulses = [];

        // Konstanta untuk panjang ikatan
        const BOND_LENGTH_C_H = 1.09;
        const BOND_LENGTH_C_C = 1.54;

        // Inisialisasi aplikasi
        function init() {
            console.log('init app');
            initNavigation();
            init3DVisualization();
            initInteractivity();
            initSimulation();
            initGame();
            initReflection();
        }

        // Initialize hover/tooltip interactivity for molecule viewer
        function initInteractivity() {
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            const tooltip = document.createElement('div');
            tooltip.id = 'atom-tooltip';
            tooltip.className = 'atom-tooltip';
            document.body.appendChild(tooltip);

            let lastHovered = null;
            renderer.domElement.addEventListener('mousemove', function(event) {
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(atomMeshes.concat(bondMeshes), true);
                if (intersects.length > 0) {
                    const obj = intersects[0].object;
                    // if we hover a different atom, reset previous
                    if (lastHovered && lastHovered !== obj) {
                        // restore scale
                        lastHovered.scale.copy(lastHovered.userData._baseScale || new THREE.Vector3(1,1,1));
                        // clear previous bond highlights
                        clearBondHighlights();
                    }

                    if (obj.userData && obj.userData.label) {
                        tooltip.style.display = 'block';
                        tooltip.textContent = obj.userData.label;
                        tooltip.style.left = event.clientX + 'px';
                        tooltip.style.top = (event.clientY - 12) + 'px';
                        // scale up hovered atom
                        obj.scale.set(1.35,1.35,1.35);
                        lastHovered = obj;
                        // highlight connected bonds visually
                        highlightConnectedBonds(obj.userData.connectedBonds || []);
                        return;
                    }
                }
                // no intersects
                if (lastHovered) {
                    lastHovered.scale.copy(lastHovered.userData._baseScale || new THREE.Vector3(1,1,1));
                    lastHovered = null;
                }
                tooltip.style.display = 'none';
                clearBondHighlights();
            });
        }

        function highlightConnectedBonds(bonds) {
            bondMeshes.forEach(b => {
                if (b.material) {
                    b.material.opacity = 0.35;
                    if (b.material.emissive) b.material.emissive.set(0x000000);
                }
            });
            bonds.forEach(b => {
                if (b && b.material) {
                    b.material.opacity = 1.0;
                    if (b.material.emissive) b.material.emissive.set(0x66ccff);
                    // start pulse
                    pulseBond(b);
                }
            });
        }

        // Simple pulse animation for a bond: animate emissive intensity over time
        function pulseBond(bond) {
            if (!bond || !bond.material) return;
            const start = performance.now();
            const duration = 450; // ms
            const id = { bond, running:true };
            activeBondPulses.push(id);
            const tick = (now) => {
                if (!id.running) return;
                const t = (now - start) / duration;
                const v = Math.sin(t * Math.PI) * 0.8 + 0.2; // 0.2..1
                if (bond.material && bond.material.emissive) {
                    const c = new THREE.Color(0x66ccff).multiplyScalar(v);
                    bond.material.emissive.setRGB(c.r, c.g, c.b);
                }
                if (t < 1) requestAnimationFrame(tick); else {
                    // end
                    if (bond.material && bond.material.emissive) bond.material.emissive.set(0x000000);
                    id.running = false;
                    // remove from active
                    const i = activeBondPulses.indexOf(id); if (i>=0) activeBondPulses.splice(i,1);
                }
            };
            requestAnimationFrame(tick);
        }

        function clearBondHighlights() {
            bondMeshes.forEach(b => {
                b.material.opacity = 1.0;
                if (b.material.emissive) b.material.emissive.set(0x000000);
            });
        }

        // Inisialisasi navigasi
        function initNavigation() {
            const navButtons = document.querySelectorAll('.nav-btn');
            const sections = document.querySelectorAll('.content-section');
            
            navButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetSection = this.getAttribute('data-section');
                    
                    // Update tombol aktif
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Tampilkan section yang sesuai
                    sections.forEach(section => {
                        section.classList.remove('active');
                        if (section.id === targetSection) {
                            section.classList.add('active');
                        }
                    });
                    
                    // Jika berpindah ke section simulasi, render ulang
                    if (targetSection === 'simulation') {
                        setTimeout(() => {
                            simulationRenderer.setSize(
                                document.getElementById('simulation-container').clientWidth,
                                document.getElementById('simulation-container').clientHeight
                            );
                        }, 100);
                    }
                });
            });
            
            // Event listener untuk prefiks
            const prefixItems = document.querySelectorAll('.prefix-item');
            prefixItems.forEach(item => {
                item.addEventListener('click', function() {
                    const prefix = this.getAttribute('data-prefix');
                    showAlkaneFromPrefix(prefix);
                });
            });

            // quick open game button
            const quick = document.getElementById('open-game-quick');
            if (quick) {
                quick.addEventListener('click', function() {
                    document.querySelector('.nav-btn[data-section="game"]').click();
                    // show lobby view
                    const wrapper = document.getElementById('game-rounds-wrapper');
                    renderGameLobby(wrapper);
                    document.getElementById('debug-panel').style.display = 'block';
                    document.getElementById('debug-panel').textContent = 'debug: opened game lobby';
                });
            }
        }

        // Inisialisasi visualisasi 3D
        function init3DVisualization() {
            // Setup scene, camera, renderer
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            
            const container = document.getElementById('molecule-container');
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 5;
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setClearColor(0x111428);
            renderer.setPixelRatio(window.devicePixelRatio ? window.devicePixelRatio : 1);
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            // Kontrol orbit
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            console.log('3D viewer initialized, renderer dom ready:', renderer.domElement ? true : false);
            
            // Pencahayaan
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7);
            scene.add(directionalLight);
            
            // Render molekul awal
            createMolecule(currentCarbonCount);
            
            // Animasi
            // start render loop
            if (typeof animate === 'function') animate();
            
            // Event listener untuk kontrol molekul
            document.getElementById('add-carbon').addEventListener('click', function() {
                if (currentCarbonCount < 8) {
                    currentCarbonCount++;
                    createMolecule(currentCarbonCount);
                    updateAlkaneInfo(currentCarbonCount);
                    try { if (document.getElementById('investigation-panel') && document.getElementById('investigation-panel').style.display === 'block') recordObservation(); } catch(e) {}
                }
            });
            
            document.getElementById('remove-carbon').addEventListener('click', function() {
                if (currentCarbonCount > 1) {
                    currentCarbonCount--;
                    createMolecule(currentCarbonCount);
                    updateAlkaneInfo(currentCarbonCount);
                    try { if (document.getElementById('investigation-panel') && document.getElementById('investigation-panel').style.display === 'block') recordObservation(); } catch(e) {}
                }
            });
            
            document.getElementById('reset-molecule').addEventListener('click', function() {
                currentCarbonCount = 1;
                createMolecule(currentCarbonCount);
                updateAlkaneInfo(currentCarbonCount);
                try { if (document.getElementById('investigation-panel') && document.getElementById('investigation-panel').style.display === 'block') recordObservation(); } catch(e) {}
            });

            // Autorotate toggle & focus
            const autoBtn = document.getElementById('toggle-autorotate');
            if (autoBtn) {
                autoBtn.addEventListener('click', function() {
                    autoRotate = !autoRotate;
                    autoBtn.textContent = autoRotate ? 'Auto-Rotate: ON' : 'Auto-Rotate: OFF';
                });
                autoBtn.textContent = autoRotate ? 'Auto-Rotate: ON' : 'Auto-Rotate: OFF';
            }

            const focusBtn = document.getElementById('focus-molecule');
            if (focusBtn) {
                focusBtn.addEventListener('click', function() {
                    if (currentMolecule && typeof fitCameraToObject === 'function') fitCameraToObject(currentMolecule, camera, controls);
                });
            }
            
            // Responsif
            window.addEventListener('resize', function() {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        }

        // Inisialisasi simulasi
        function initSimulation() {
            // Setup scene, camera, renderer untuk simulasi
            simulationScene = new THREE.Scene();
            simulationScene.background = new THREE.Color(0x1a1a2e);
            
            const container = document.getElementById('simulation-container');
            simulationCamera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            simulationCamera.position.z = 5;
            
            simulationRenderer = new THREE.WebGLRenderer({ antialias: true });
            simulationRenderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(simulationRenderer.domElement);
            
            // Kontrol orbit
            simulationControls = new THREE.OrbitControls(simulationCamera, simulationRenderer.domElement);
            simulationControls.enableDamping = true;
            simulationControls.dampingFactor = 0.05;
            
            // Pencahayaan
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            simulationScene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7);
            simulationScene.add(directionalLight);
            
            // Render molekul untuk simulasi
            createSimulationMolecule(5);
            
            // Animasi simulasi
            animateSimulation();
            
            // Event listener untuk kontrol simulasi
            document.getElementById('show-bonds').addEventListener('click', function() {
                highlightBonds();
            });
            
            document.getElementById('hide-hydrogen').addEventListener('click', function() {
                hideHydrogenAtoms();
            });
            
            document.getElementById('show-all').addEventListener('click', function() {
                showAllAtoms();
            });
            
            // Responsif
            window.addEventListener('resize', function() {
                simulationCamera.aspect = container.clientWidth / container.clientHeight;
                simulationCamera.updateProjectionMatrix();
                simulationRenderer.setSize(container.clientWidth, container.clientHeight);
            });
        }

        // Inisialisasi permainan
        function initGame() {
            // Event listener untuk tombol periksa jawaban
            // Show interactive lobby first
            const wrapper = document.getElementById('game-rounds-wrapper');
            // ensure state indicates no round selected
            if (!gameState) gameState = { currentRound: null, currentBabakIndex: 0, answers: [], roundConclusions: {1:'',2:'',3:''} };
            gameState.currentRound = null;
            renderGameLobby(wrapper);
            // Update total rounds display
            document.getElementById('total-rounds').textContent = '3';
            // add small note for total questions
            document.getElementById('total-questions').textContent = gameQuestions.length;
        }

        // Inisialisasi refleksi
        function initReflection() {
            document.getElementById('submit-reflection').addEventListener('click', function() {
                // Tampilkan sertifikat
                document.getElementById('certificate').classList.add('active');
                
                // Tampilkan nama siswa (dalam implementasi nyata, ini bisa diisi dari input)
                document.getElementById('student-name').textContent = "Eksplorator Alkana";
                document.getElementById('certificate-score').textContent = gameScore;
                
                // Scroll ke sertifikat
                document.getElementById('certificate').scrollIntoView({ behavior: 'smooth' });
            });
        }

        // Fungsi untuk membuat molekul berdasarkan jumlah atom karbon (lebih detail, interaktif)
    function createMolecule(carbonCount, branches = []) {
            // Hapus molekul sebelumnya
            if (currentMolecule) {
                scene.remove(currentMolecule);
            }

            atomMeshes = [];
            bondMeshes = [];

            const molecule = new THREE.Group();

            // positions
            const carbonPositions = [];
            for (let i = 0; i < carbonCount; i++) {
                const x = i * BOND_LENGTH_C_C - (carbonCount-1)*BOND_LENGTH_C_C/2;
                carbonPositions.push(new THREE.Vector3(x, 0, 0));
            }

            // Buat atom karbon
            carbonPositions.forEach((pos, i) => {
                const carbon = createAtom(0x333333, 0.4, pos.x, pos.y, pos.z);
                carbon.userData = { label: 'C (atom ' + (i+1) + ')', connectedBonds: [] };
                molecule.add(carbon);
                atomMeshes.push(carbon);
            });

            // Buat ikatan antara karbon
            for (let i = 0; i < carbonPositions.length - 1; i++) {
                const start = carbonPositions[i];
                const end = carbonPositions[i+1];
                const bond = createBondBetween(start, end, 0.08, 0xcccccc);
                molecule.add(bond);
            }

            // Buat atom hidrogen dengan pola lebih detil: ujung = CH3 (3 H), tengah = CH2 (2 H)
            for (let i = 0; i < carbonPositions.length; i++) {
                const carbonPos = carbonPositions[i];
                const carbonMesh = atomMeshes[i];
                carbonMesh.userData.connectedBonds = carbonMesh.userData.connectedBonds || [];

                if (carbonCount === 1) {
                    // Metana CH4
                    const hs = [
                        new THREE.Vector3(carbonPos.x + BOND_LENGTH_C_H, carbonPos.y, carbonPos.z),
                        new THREE.Vector3(carbonPos.x - BOND_LENGTH_C_H, carbonPos.y, carbonPos.z),
                        new THREE.Vector3(carbonPos.x, carbonPos.y + BOND_LENGTH_C_H, carbonPos.z),
                        new THREE.Vector3(carbonPos.x, carbonPos.y, carbonPos.z + BOND_LENGTH_C_H)
                    ];
                    hs.forEach(hPos => {
                        const h = createAtom(0xffffff, 0.18, hPos.x, hPos.y, hPos.z);
                        h.userData = { label: 'H', connectedBonds: [] };
                        molecule.add(h);
                        atomMeshes.push(h);
                        const bond = createBondBetween(carbonPos, h.position, 0.05, 0x66bbff); // blueish C-H
                        molecule.add(bond);
                        carbonMesh.userData.connectedBonds.push(bond);
                        h.userData.connectedBonds.push(bond);
                    });
                    addLabelToMolecule(molecule, carbonPos, 'CH‚ÇÑ');
                } else if (i === 0 || i === carbonCount - 1) {
                    // ujung: CH3 (3 H)
                    const dir = i === 0 ? -1 : 1;
                    const hs = [
                        new THREE.Vector3(carbonPos.x + dir * BOND_LENGTH_C_H, carbonPos.y, carbonPos.z),
                        new THREE.Vector3(carbonPos.x, carbonPos.y + BOND_LENGTH_C_H, carbonPos.z),
                        new THREE.Vector3(carbonPos.x, carbonPos.y, carbonPos.z + BOND_LENGTH_C_H)
                    ];
                    hs.forEach(hPos => {
                        const h = createAtom(0xffffff, 0.16, hPos.x, hPos.y, hPos.z);
                        h.userData = { label: 'H', connectedBonds: [] };
                        molecule.add(h);
                        atomMeshes.push(h);
                        const bond = createBondBetween(carbonPos, h.position, 0.05, 0x66bbff);
                        molecule.add(bond);
                        carbonMesh.userData.connectedBonds.push(bond);
                        h.userData.connectedBonds.push(bond);
                    });
                    addLabelToMolecule(molecule, carbonPos, 'CH‚ÇÉ');
                } else {
                    // tengah: CH2 (2 H)
                    const hs = [
                        new THREE.Vector3(carbonPos.x, carbonPos.y + BOND_LENGTH_C_H, carbonPos.z),
                        new THREE.Vector3(carbonPos.x, carbonPos.y, carbonPos.z + BOND_LENGTH_C_H)
                    ];
                    hs.forEach(hPos => {
                        const h = createAtom(0xffffff, 0.16, hPos.x, hPos.y, hPos.z);
                        h.userData = { label: 'H', connectedBonds: [] };
                        molecule.add(h);
                        atomMeshes.push(h);
                        const bond = createBondBetween(carbonPos, h.position, 0.05, 0x66bbff);
                        molecule.add(bond);
                        carbonMesh.userData.connectedBonds.push(bond);
                        h.userData.connectedBonds.push(bond);
                    });
                    addLabelToMolecule(molecule, carbonPos, 'CH‚ÇÇ');
                }
            }

            // Render branches (mis. metil) jika ada
            if (Array.isArray(branches) && branches.length > 0) {
                branches.forEach((br, idx) => {
                    try {
                        const posIndex = Number(br.pos) - 1;
                        if (isNaN(posIndex) || posIndex < 0 || posIndex >= carbonPositions.length) return;
                        const basePos = carbonPositions[posIndex];
                        // choose offset direction so branches are visible (alternate +/- z)
                        const dirZ = (posIndex % 2 === 0) ? 1 : -1;
                        const branchOffset = new THREE.Vector3(0, 0, dirZ * BOND_LENGTH_C_C);
                        const branchCarbonPos = basePos.clone().add(branchOffset);

                        const branchCarbon = createAtom(0x333333, 0.34, branchCarbonPos.x, branchCarbonPos.y, branchCarbonPos.z);
                        branchCarbon.userData = { label: 'C (cab)' + (posIndex+1), connectedBonds: [] };
                        molecule.add(branchCarbon);
                        atomMeshes.push(branchCarbon);

                        // bond to main chain
                        const bBond = createBondBetween(basePos, branchCarbon.position, 0.07, 0xffcc66);
                        molecule.add(bBond);
                        // attach connected bonds to meshes
                        const baseMesh = atomMeshes[posIndex];
                        if (baseMesh && baseMesh.userData) baseMesh.userData.connectedBonds.push(bBond);
                        if (branchCarbon.userData) branchCarbon.userData.connectedBonds.push(bBond);

                        // add hydrogens for CH3 on branch carbon
                        const h1 = createAtom(0xffffff, 0.15, branchCarbonPos.x + BOND_LENGTH_C_H, branchCarbonPos.y, branchCarbonPos.z);
                        const h2 = createAtom(0xffffff, 0.15, branchCarbonPos.x, branchCarbonPos.y + BOND_LENGTH_C_H, branchCarbonPos.z);
                        const h3 = createAtom(0xffffff, 0.15, branchCarbonPos.x, branchCarbonPos.y, branchCarbonPos.z + (dirZ * BOND_LENGTH_C_H));
                        [h1,h2,h3].forEach(h => {
                            h.userData = { label: 'H', connectedBonds: [] };
                            molecule.add(h);
                            atomMeshes.push(h);
                            const hb = createBondBetween(branchCarbon.position, h.position, 0.045, 0x66bbff);
                            molecule.add(hb);
                            if (branchCarbon.userData) branchCarbon.userData.connectedBonds.push(hb);
                            h.userData.connectedBonds.push(hb);
                        });

                        addLabelToMolecule(molecule, branchCarbonPos, 'CH‚ÇÉ');
                    } catch (err) {
                        console.warn('branch render error', err);
                    }
                });
            }

            scene.add(molecule);
            currentMolecule = molecule;

            // adjust camera to fit new molecule
            if (typeof fitCameraToObject === 'function') fitCameraToObject(currentMolecule, camera, controls);
        }

        // Fit camera to object bounding box
        function fitCameraToObject(object, camera, controls) {
            try {
                const box = new THREE.Box3().setFromObject(object);
                const size = box.getSize(new THREE.Vector3()).length();
                const center = box.getCenter(new THREE.Vector3());
                const distance = Math.max(size * 1.2, 4);
                camera.position.set(center.x, center.y, center.z + distance);
                camera.lookAt(center);
                if (controls) {
                    controls.target.copy(center);
                    controls.update();
                }
            } catch (e) {
                // ignore
            }
        }

        // Fungsi untuk membuat molekul simulasi
        function createSimulationMolecule(carbonCount) {
            // Implementasi serupa dengan createMolecule, tetapi untuk scene simulasi
            // Untuk demo, kita buat molekul pentana
            const molecule = new THREE.Group();
            simulationAtomMeshes = [];
            simulationBondMeshes = [];
            
            // Buat atom karbon
            for (let i = 0; i < carbonCount; i++) {
                const carbon = createAtom(0x333333, 0.4, i * BOND_LENGTH_C_C - (carbonCount-1)*BOND_LENGTH_C_C/2, 0, 0);
                molecule.add(carbon);
                simulationAtomMeshes.push(carbon);
            }
            
            // Buat ikatan antara karbon
            for (let i = 0; i < carbonCount - 1; i++) {
                const start = new THREE.Vector3(i * BOND_LENGTH_C_C - (carbonCount-1)*BOND_LENGTH_C_C/2, 0, 0);
                const end = new THREE.Vector3((i+1) * BOND_LENGTH_C_C - (carbonCount-1)*BOND_LENGTH_C_C/2, 0, 0);
                const bond = createBond(start, end, 0.08);
                molecule.add(bond);
                simulationBondMeshes.push(bond);
            }
            
            // Buat atom hidrogen (implementasi sederhana)
            // Untuk demo, kita buat hidrogen hanya di beberapa posisi
            const firstCarbonPos = new THREE.Vector3(-(carbonCount-1)*BOND_LENGTH_C_C/2, 0, 0);
            const h1 = createAtom(0xffffff, 0.2, firstCarbonPos.x - BOND_LENGTH_C_H, firstCarbonPos.y, firstCarbonPos.z);
            molecule.add(h1);
            simulationAtomMeshes.push(h1);
            const bond1 = createBond(firstCarbonPos, h1.position);
            molecule.add(bond1);
            simulationBondMeshes.push(bond1);
            
            const lastCarbonPos = new THREE.Vector3((carbonCount-1)*BOND_LENGTH_C_C/2, 0, 0);
            const h2 = createAtom(0xffffff, 0.2, lastCarbonPos.x + BOND_LENGTH_C_H, lastCarbonPos.y, lastCarbonPos.z);
            molecule.add(h2);
            simulationAtomMeshes.push(h2);
            const bond2 = createBond(lastCarbonPos, h2.position);
            molecule.add(bond2);
            simulationBondMeshes.push(bond2);
            
            simulationScene.add(molecule);
        }

        // Simple animation loop for main viewer
        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            // subtle rotation/bob for the current molecule to make it feel alive
            if (currentMolecule) {
                currentMolecule.rotation.y += 0.0025;
                const t = Date.now() * 0.001;
                currentMolecule.position.y = Math.sin(t) * 0.02;
            }
            // auto-rotate camera around target
            if (autoRotate && controls && controls.target) {
                const t = Date.now() * 0.0002;
                const radius = camera.position.length();
                camera.position.x = Math.cos(t) * radius;
                camera.position.z = Math.sin(t) * radius;
                camera.lookAt(controls.target);
            }
            if (renderer && scene && camera) renderer.render(scene, camera);
        }

        // Simple animation loop for simulation viewer
        function animateSimulation() {
            requestAnimationFrame(animateSimulation);
            if (simulationControls) simulationControls.update();
            if (simulationRenderer && simulationScene && simulationCamera) simulationRenderer.render(simulationScene, simulationCamera);
        }

        // Simulation control helpers
        function highlightBonds() {
            simulationBondMeshes.forEach(b => {
                if (b.material) b.material.emissive && b.material.emissive.set(0x4a9cff);
            });
        }

        function hideHydrogenAtoms() {
            simulationAtomMeshes.forEach(a => {
                // assume hydrogens are smaller (size ~0.16-0.2) based on creation
                if (a.geometry && a.geometry.parameters && a.geometry.parameters.radius <= 0.2) {
                    a.visible = false;
                }
            });
        }

        function showAllAtoms() {
            simulationAtomMeshes.forEach(a => a.visible = true);
            simulationBondMeshes.forEach(b => {
                if (b.material && b.material.emissive) b.material.emissive.set(0x000000);
            });
        }

        // Fungsi untuk membuat atom
        function createAtom(color, size, x, y, z) {
            const geometry = new THREE.SphereGeometry(size, ATOM_SEGMENTS, ATOM_SEGMENTS);
            const material = new THREE.MeshStandardMaterial({ color: color, metalness: 0.2, roughness: 0.5, emissive: 0x000000 });
            const atom = new THREE.Mesh(geometry, material);
            atom.position.set(x, y, z);
            atom.userData = atom.userData || {};
            atom.userData._baseScale = new THREE.Vector3(1,1,1);
            return atom;
        }

        // Tambahkan label teks sederhana (2D HTML overlay) untuk setiap grup atom
        function addLabelToMolecule(moleculeGroup, positionVec3, text) {
            // We'll attach a simple sprite-like object using CSS2D-like approach
            // Create a plane with canvas texture showing the text
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'rgba(0,0,0,0.6)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.font = '20px sans-serif';
            ctx.fillStyle = '#fff';
            ctx.textAlign = 'center';
            ctx.fillText(text, canvas.width / 2, canvas.height / 2 + 7);

            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.SpriteMaterial({ map: texture, depthTest: false });
            const sprite = new THREE.Sprite(material);
            sprite.scale.set(0.9, 0.45, 1);
            sprite.position.copy(positionVec3.clone().add(new THREE.Vector3(0, 0.7, 0)));
            moleculeGroup.add(sprite);
        }

        // Fungsi untuk membuat ikatan (mesh saja)
        function createBond(start, end, radius = 0.05, color = 0x888888) {
            const direction = new THREE.Vector3().subVectors(end, start);
            const length = direction.length();
            const geometry = new THREE.CylinderGeometry(radius, radius, length, BOND_CYL_SEGMENTS);
            geometry.translate(0, length/2, 0);

            const material = new THREE.MeshStandardMaterial({ color: color, metalness: 0.1, roughness: 0.6, emissive: 0x000000 });
            const bond = new THREE.Mesh(geometry, material);
            bond.userData = bond.userData || {};
            bond.userData._baseRadius = radius;
            bond.position.copy(start);
            bond.lookAt(end);
            return bond;
        }

        // Create bond and register for interactivity
        function createBondBetween(start, end, radius = 0.06, color = 0x888888) {
            const bond = createBond(start, end, radius, color);
            bondMeshes.push(bond);
            return bond;
        }

        // Fungsi untuk memperbarui informasi alkana
        function updateAlkaneInfo(carbonCount) {
            const alkaneNames = ["", "Metana", "Etana", "Propana", "Butana", "Pentana", "Heksana", "Heptana", "Oktana"];
            const alkaneFormulas = ["", "CH‚ÇÑ", "C‚ÇÇH‚ÇÜ", "C‚ÇÉH‚Çà", "C‚ÇÑH‚ÇÅ‚ÇÄ", "C‚ÇÖH‚ÇÅ‚ÇÇ", "C‚ÇÜH‚ÇÅ‚ÇÑ", "C‚ÇáH‚ÇÅ‚ÇÜ", "C‚ÇàH‚ÇÅ‚Çà"];
            
            document.getElementById('alkane-name').textContent = alkaneNames[carbonCount] + " (" + alkaneFormulas[carbonCount] + ")";
            document.getElementById('molecular-formula').textContent = alkaneFormulas[carbonCount];
            
            let description = "Alkana dengan " + carbonCount + " atom karbon. ";
            description += "Rumus molekul: " + alkaneFormulas[carbonCount] + ". ";
            description += "Struktur rantai lurus dengan ikatan tunggal antara atom karbon.";
            
            document.getElementById('alkane-description').textContent = description;
        }

        // Render dynamic rounds (clean implementation)
        function renderGameRounds() {
            const wrapper = document.getElementById('game-rounds-wrapper');
            wrapper.innerHTML = '';

            const rounds = [1,2,3].map(r => ({ round: r, questions: gameQuestions.filter(q => q.round === r) }));

            rounds.forEach(rObj => {
                const roundDiv = document.createElement('div');
                roundDiv.className = 'game-container';
                roundDiv.id = `game-round-${rObj.round}`;
                if (rObj.round !== 1) roundDiv.style.display = 'none';

                const h3 = document.createElement('h3');
                h3.textContent = `Ronde ${rObj.round}: ${rObj.round===1? 'Alkana Rantai Panjang': rObj.round===2? 'Alkana Rantai Bercabang':'Campuran'}`;
                roundDiv.appendChild(h3);

                rObj.questions.forEach((q, idx) => {
                    const qIndex = gameQuestions.indexOf(q);
                    const questionEl = document.createElement('div');
                    questionEl.className = 'game-question';
                    questionEl.textContent = `Babak ${idx+1}: ${q.prompt}`;

                    // controls row: 3D, Hint, Timer
                    const controlRow = document.createElement('div');
                    controlRow.style.marginTop = '8px';

                    const btn3d = document.createElement('button');
                    btn3d.className = 'control-btn';
                    btn3d.textContent = 'Tampilkan 3D';
                    btn3d.style.marginRight = '8px';
                    btn3d.addEventListener('click', () => { showQuestionStructure(q); startQuestionTimer(questionEl, 90); });
                    controlRow.appendChild(btn3d);

                    const hintBtn = document.createElement('button');
                    hintBtn.className = 'control-btn';
                    hintBtn.textContent = 'Tanya (Hint bertahap)';
                    hintBtn.style.marginRight = '8px';
                    hintBtn.addEventListener('click', () => revealNextHint(questionEl, q));
                    controlRow.appendChild(hintBtn);

                    const timerBubble = document.createElement('span');
                    timerBubble.className = 'timer-bubble';
                    timerBubble.textContent = '--:--';
                    controlRow.appendChild(timerBubble);

                    questionEl.appendChild(controlRow);

                    // small 2D diagram helper
                    const diagram = generate2DDiagramForQuestion(q);
                    const diagramWrapper = document.createElement('div');
                    diagramWrapper.className = 'diagram-2d';
                    diagramWrapper.appendChild(diagram);
                    questionEl.appendChild(diagramWrapper);

                    const optionsGrid = document.createElement('div');
                    optionsGrid.className = 'game-options';
                    q.choices.forEach(choice => {
                        const opt = document.createElement('div');
                        opt.className = 'game-option';
                        opt.textContent = choice;
                        opt.dataset.questionIndex = qIndex;
                        opt.dataset.choice = choice;
                        opt.addEventListener('click', onGameOptionClick);
                        optionsGrid.appendChild(opt);
                    });

                    const feedback = document.createElement('div');
                    feedback.className = 'feedback';
                    feedback.style.display = 'none';

                    // Prediction / discovery row
                    const predRow = document.createElement('div');
                    predRow.className = 'prediction-row';
                    const predInput = document.createElement('input');
                    predInput.className = 'prediction-input';
                    predInput.placeholder = 'Tebak nama atau jawaban (mis. Propana / 2-metilbutana)';
                    const predBtn = document.createElement('button');
                    predBtn.className = 'control-btn';
                    predBtn.textContent = 'Uji Prediksi';
                    predBtn.addEventListener('click', () => testPrediction(qIndex, predInput, questionEl));
                    predRow.appendChild(predInput);
                    predRow.appendChild(predBtn);
                    questionEl.appendChild(predRow);

                    const controls = document.createElement('div');
                    controls.className = 'game-controls';
                    const checkBtn = document.createElement('button');
                    checkBtn.className = 'game-btn';
                    checkBtn.textContent = 'Periksa Jawaban';
                    checkBtn.dataset.questionIndex = qIndex;
                    checkBtn.addEventListener('click', checkQuestionAnswer);
                    controls.appendChild(checkBtn);

                    // hint box (hidden by default)
                    const hintBox = document.createElement('div');
                    hintBox.className = 'hint-box';
                    hintBox.textContent = q.hint || 'Tidak ada hint tersedia.';
                    questionEl.appendChild(hintBox);

                    // attach timer handles
                    questionEl._timerBubble = timerBubble;
                    questionEl._timerId = null;

                    questionEl.appendChild(optionsGrid);
                    questionEl.appendChild(controls);
                    questionEl.appendChild(feedback);
                    roundDiv.appendChild(questionEl);
                });

                // Conclusion textarea
                const conclDiv = document.createElement('div');
                conclDiv.className = 'reflection-section';
                conclDiv.innerHTML = `<h4>Kesimpulan Ronde ${rObj.round}</h4>`;
                const textarea = document.createElement('textarea');
                textarea.className = 'reflection-input';
                textarea.placeholder = 'Tulis kesimpulanmu untuk ronde ini...';
                textarea.dataset.round = rObj.round;
                conclDiv.appendChild(textarea);

                const nextBtn = document.createElement('button');
                nextBtn.className = 'game-btn next';
                nextBtn.textContent = rObj.round === 3 ? 'Lihat Hasil' : 'Lanjut ke Ronde Berikutnya';
                nextBtn.addEventListener('click', () => proceedToNextRound(rObj.round));
                conclDiv.appendChild(nextBtn);

                roundDiv.appendChild(conclDiv);
                wrapper.appendChild(roundDiv);
            });
        }

        // Generate a small SVG 2D diagram for a question (heuristic)
        function generate2DDiagramForQuestion(q) {
            const svgNS = 'http://www.w3.org/2000/svg';
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('width', '220');
            svg.setAttribute('height', '80');

            // heuristic: look for numbers like '3 atom C' or names like '3-metilpentana' to draw chain
            let chainLength = null;
            const m = q.prompt.match(/(\d+) atom C/);
            if (m) chainLength = parseInt(m[1], 10);

            // fallback for names
            if (!chainLength) {
                const nameMatch = q.prompt.match(/(\d)-?metil|pentana|butana|heksana|propana|etana|metana/gi);
                // quick simple heuristic - use 5 for pentana mentions
                if (/pentana/i.test(q.prompt)) chainLength = 5;
                else if (/butana/i.test(q.prompt)) chainLength = 4;
                else if (/heksana/i.test(q.prompt)) chainLength = 6;
                else if (/propana/i.test(q.prompt)) chainLength = 3;
                else if (/etana/i.test(q.prompt)) chainLength = 2;
                else if (/metana/i.test(q.prompt)) chainLength = 1;
            }

            if (!chainLength) chainLength = 5; // default visual

            const startX = 12;
            const startY = 40;
            const gap = 32;

            for (let i = 0; i < chainLength; i++) {
                const cx = startX + i * gap;
                const circle = document.createElementNS(svgNS, 'circle');
                circle.setAttribute('cx', cx);
                circle.setAttribute('cy', startY);
                circle.setAttribute('r', 8);
                circle.setAttribute('fill', i===0||i===chainLength-1 ? '#333' : '#444');
                svg.appendChild(circle);

                // label CH3 or CH2
                const label = document.createElementNS(svgNS, 'text');
                label.setAttribute('x', cx);
                label.setAttribute('y', startY - 14);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('fill', '#fff');
                label.setAttribute('font-size', '10');
                label.textContent = chainLength === 1 ? 'CH‚ÇÑ' : (i===0||i===chainLength-1 ? 'CH‚ÇÉ' : 'CH‚ÇÇ');
                svg.appendChild(label);

                if (i > 0) {
                    const prevX = startX + (i-1) * gap;
                    const line = document.createElementNS(svgNS, 'line');
                    line.setAttribute('x1', prevX + 8);
                    line.setAttribute('y1', startY);
                    line.setAttribute('x2', cx - 8);
                    line.setAttribute('y2', startY);
                    line.setAttribute('stroke', '#bbb');
                    line.setAttribute('stroke-width', '2');
                    svg.appendChild(line);
                }
            }

            // If the prompt mentions 'metil' with a number, draw a small branch marker
            const metilMatch = q.prompt.match(/(\d)-?metil/);
            if (metilMatch) {
                const pos = Number(metilMatch[1]) - 1;
                const branchX = startX + pos * gap;
                const branchLine = document.createElementNS(svgNS, 'line');
                branchLine.setAttribute('x1', branchX);
                branchLine.setAttribute('y1', startY - 8);
                branchLine.setAttribute('x2', branchX);
                branchLine.setAttribute('y2', startY - 28);
                branchLine.setAttribute('stroke', '#ffcc00');
                branchLine.setAttribute('stroke-width', '2');
                svg.appendChild(branchLine);

                const branchCircle = document.createElementNS(svgNS, 'circle');
                branchCircle.setAttribute('cx', branchX);
                branchCircle.setAttribute('cy', startY - 36);
                branchCircle.setAttribute('r', 6);
                branchCircle.setAttribute('fill', '#333');
                svg.appendChild(branchCircle);

                const bLabel = document.createElementNS(svgNS, 'text');
                bLabel.setAttribute('x', branchX);
                bLabel.setAttribute('y', startY - 44);
                bLabel.setAttribute('text-anchor', 'middle');
                bLabel.setAttribute('fill', '#fff');
                bLabel.setAttribute('font-size', '10');
                bLabel.textContent = 'CH‚ÇÉ';
                svg.appendChild(bLabel);
            }

            return svg;
        }

        // Small game UI helpers: lobby, hint, and timer
        function renderGameLobby(container) {
            container.innerHTML = '';
            const lobby = document.createElement('div');
            lobby.className = 'game-lobby';
            for (let r = 1; r <= 3; r++) {
                const card = document.createElement('div');
                card.className = 'round-card';
                const title = document.createElement('div');
                title.className = 'rc-title';
                title.textContent = `Ronde ${r}`;
                const desc = document.createElement('div');
                desc.className = 'rc-desc';
                const topics = r === 1 ? 'Rantai lurus' : (r === 2 ? 'Rantai bercabang' : 'Campuran & tantangan');
                desc.textContent = topics;
                const progress = document.createElement('div');
                progress.className = 'rc-progress';
                const fill = document.createElement('div');
                fill.className = 'rc-fill';
                const startIdx = (r - 1) * 3;
                let completed = 0;
                for (let i = 0; i < 3; i++) if (gameState.answers[startIdx + i] !== undefined) completed++;
                const pct = Math.round((completed / 3) * 100);
                fill.style.width = pct + '%';
                progress.appendChild(fill);

                const openBtn = document.createElement('button');
                openBtn.className = 'control-btn';
                openBtn.textContent = completed === 3 ? 'Ulangi Ronde' : 'Mulai Ronde';
                openBtn.onclick = () => {
                    gameState.currentRound = r;
                    renderGameRounds();
                    document.getElementById('game-rounds-wrapper').scrollIntoView({behavior:'smooth'});
                };

                card.appendChild(title);
                card.appendChild(desc);
                card.appendChild(progress);
                card.appendChild(openBtn);
                lobby.appendChild(card);
            }
            container.appendChild(lobby);
        }

        function toggleHint(questionEl, text) {
            const hint = questionEl.querySelector('.hint-box');
            if (!hint) return;
            if (hint.style.display === 'block') hint.style.display = 'none';
            else {
                hint.style.display = 'block';
                hint.textContent = text;
                hint.animate([{opacity:0, transform:'translateY(-6px)'},{opacity:1, transform:'translateY(0)'}], {duration:240, easing:'ease-out'});
            }
        }

        function startQuestionTimer(questionEl, seconds = 90) {
            if (!questionEl) return;
            clearInterval(questionEl._timerId);
            let remaining = seconds;
            const bubble = questionEl._timerBubble;
            function tick(){
                const mm = Math.floor(remaining/60).toString().padStart(2,'0');
                const ss = (remaining%60).toString().padStart(2,'0');
                if (bubble) bubble.textContent = `${mm}:${ss}`;
                remaining--;
                if (remaining < 0) {
                    clearInterval(questionEl._timerId);
                    if (bubble) bubble.textContent = '00:00';
                    const qIdx = findQuestionIndexByPrompt(questionEl.textContent);
                    if (qIdx !== -1 && gameState.answers.findIndex(a=>a.questionIndex===qIdx) === -1) {
                        // mark as incorrect automatically
                        markAnswer(qIdx, false, 'Waktu habis');
                    }
                }
            }
            tick();
            questionEl._timerId = setInterval(tick, 1000);
        }

        function findQuestionIndexByPrompt(text) {
            if (!text) return -1;
            for (let i=0;i<gameQuestions.length;i++) if (text.indexOf(gameQuestions[i].prompt) !== -1) return i;
            return -1;
        }

        function markAnswer(qIdx, correct, reason) {
            // update state
            gameState.answers.push({ questionIndex: qIdx, selected: null, correct: correct });
            // find the corresponding visual question and show feedback
            const wrapper = document.getElementById('game-rounds-wrapper');
            const qEls = wrapper.querySelectorAll('.game-question');
            qEls.forEach(qEl => {
                if (qEl.textContent.indexOf(gameQuestions[qIdx].prompt) !== -1) {
                    qEl.style.border = correct ? '2px solid rgba(54,200,120,0.6)' : '2px solid rgba(220,50,50,0.6)';
                    const fb = document.createElement('div');
                    fb.style.marginTop = '10px';
                    fb.style.padding = '8px';
                    fb.style.borderRadius = '6px';
                    fb.style.background = correct ? 'rgba(54,200,120,0.08)' : 'rgba(220,50,50,0.06)';
                    fb.textContent = correct ? 'Waktu habis. Jawaban dianggap salah.' : 'Waktu habis. Jawaban dianggap salah.';
                    qEl.appendChild(fb);
                }
            });
        }

        // Render a question's structure in 3D viewer. Parse simple branch like '2-metil' or '3-metil'.
        function showQuestionStructure(q) {
            console.log('showQuestionStructure for:', q.prompt);
            // simple parser: find main chain length and branches
            let mainChain = null;
            const m = q.prompt.match(/(\d+) atom C/);
            if (m) mainChain = parseInt(m[1], 10);
            if (!mainChain) {
                if (/pentana/i.test(q.prompt)) mainChain = 5;
                else if (/butana/i.test(q.prompt)) mainChain = 4;
                else if (/heksana/i.test(q.prompt)) mainChain = 6;
                else if (/propana/i.test(q.prompt)) mainChain = 3;
                else if (/etana/i.test(q.prompt)) mainChain = 2;
                else if (/metana/i.test(q.prompt)) mainChain = 1;
            }

            // detect metil positions
            const branches = [];
            const re = /(\d)-?metil/gi;
            let bm;
            while ((bm = re.exec(q.prompt)) !== null) {
                branches.push({ pos: Number(bm[1]), type: 'metil' });
            }

            if (!mainChain) mainChain = 5;

            // call createMolecule with branch data
            createMolecule(mainChain, branches);
            // ensure viewer resets camera a bit
            camera.position.set(0, 0, Math.max(4, mainChain));
            controls.update();
        }

        // Fungsi untuk menampilkan alkana berdasarkan prefiks
        function showAlkaneFromPrefix(prefix) {
            const prefixMap = {
                "meth": 1,
                "eth": 2,
                "prop": 3,
                "but": 4,
                "pent": 5,
                "hex": 6,
                "hept": 7,
                "oct": 8
            };

            const carbonCount = prefixMap[prefix];
            if (carbonCount) {
                // Pindah ke section pengenalan alkana
                document.querySelector('.nav-btn[data-section="intro"]').click();

                // Update molekul
                currentCarbonCount = carbonCount;
                createMolecule(currentCarbonCount);
                updateAlkaneInfo(currentCarbonCount);
            }
        }
        // (removed duplicate stray UI-builder block)

        function onGameOptionClick(e) {
            const clicked = e.currentTarget;
            const container = clicked.parentElement;
            const siblings = container.querySelectorAll('.game-option');
            siblings.forEach(s => s.classList.remove('selected'));
            clicked.classList.add('selected');
        }

        function checkQuestionAnswer(e) {
            const btn = e.currentTarget;
            const qIndex = Number(btn.dataset.questionIndex);
            const q = gameQuestions[qIndex];
            const container = btn.closest('.game-question');
            const options = container.querySelectorAll('.game-option');
            const feedback = container.querySelector('.feedback');
            feedback.style.display = 'flex';
            feedback.innerHTML = '';

            let selected = null;
            options.forEach(opt => {
                if (opt.classList.contains('selected')) selected = opt;
            });

            if (!selected) {
                feedback.className = 'feedback incorrect';
                feedback.innerHTML = '<span class="icon">‚ùó</span><span>Silakan pilih jawaban terlebih dahulu.</span>';
                return;
            }

            // Mark correct/incorrect visuals
            options.forEach(opt => {
                if (opt.textContent === q.answer) {
                    opt.classList.add('correct');
                }
                if (opt.classList.contains('selected') && opt.textContent !== q.answer) {
                    opt.classList.add('incorrect');
                }
                // disable further clicking
                opt.style.pointerEvents = 'none';
            });

            const isCorrect = selected.textContent === q.answer;
            gameState.answers.push({ questionIndex: qIndex, selected: selected.textContent, correct: isCorrect });

            if (isCorrect) {
                feedback.className = 'feedback correct';
                feedback.innerHTML = '<span class="icon">‚úîÔ∏è</span><span>Jawaban benar! ' + q.hint + '</span>';
                // audio cue
                playTone(880, 0.06, 0.02);
            } else {
                feedback.className = 'feedback incorrect';
                feedback.innerHTML = '<span class="icon">‚úñÔ∏è</span><span>Salah. Jawaban benar: <strong>' + q.answer + '</strong>. ' + q.hint + '</span>';
                playTone(220, 0.12, 0.04);
            }

            // disable check button after checking
            btn.disabled = true;
        }

        // small utility for short tones
        function playTone(freq, dur=0.08, attack=0.01) {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = 'sine'; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
                g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.12, audioCtx.currentTime + attack);
                g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
                o.connect(g); g.connect(audioCtx.destination);
                o.start(); o.stop(audioCtx.currentTime + dur + 0.02);
            } catch (e) { }
        }

        function proceedToNextRound(currentRoundNumber) {
            // Ensure all questions in this round have been checked and conclusion entered
            const roundDiv = document.getElementById(`game-round-${currentRoundNumber}`);
            const questionEls = roundDiv.querySelectorAll('.game-question');
            for (let qEl of questionEls) {
                const checkBtn = qEl.querySelector('.game-controls .game-btn');
                if (!checkBtn.disabled) {
                    alert('Selesaikan semua babak pada ronde ini dengan menekan "Periksa Jawaban" pada setiap soal.');
                    return;
                }
            }

            const textarea = roundDiv.querySelector('.reflection-input');
            if (!textarea.value.trim()) {
                alert('Tuliskan kesimpulan untuk ronde ini sebelum melanjutkan.');
                textarea.focus();
                return;
            }

            gameState.roundConclusions[currentRoundNumber] = textarea.value.trim();

            // Move to next or show results
            if (currentRoundNumber < 3) {
                document.getElementById(`game-round-${currentRoundNumber}`).style.display = 'none';
                document.getElementById(`game-round-${currentRoundNumber+1}`).style.display = 'block';
                document.getElementById('current-round').textContent = String(currentRoundNumber+1);
                const progress = (currentRoundNumber+1) / 3 * 100;
                document.getElementById('game-progress').style.width = progress + '%';
                // scroll into view
                document.getElementById(`game-round-${currentRoundNumber+1}`).scrollIntoView({behavior:'smooth'});
            } else {
                // show summary
                showGameSummary();
            }
        }

        function showGameSummary() {
            // compute score
            const totalCorrect = gameState.answers.filter(a => a.correct).length;
            document.getElementById('final-score').textContent = totalCorrect;
            document.getElementById('total-questions').textContent = gameQuestions.length;

            // show per-round summaries
            const summaryDiv = document.getElementById('round-summaries');
            summaryDiv.innerHTML = '';
            for (let r=1; r<=3; r++) {
                const block = document.createElement('div');
                block.innerHTML = `<h4>Ronde ${r} - Kesimpulan:</h4><p>${gameState.roundConclusions[r] || '-'}</p>`;
                summaryDiv.appendChild(block);
            }

            // show results section
            document.getElementById('game-rounds-wrapper').style.display = 'none';
            document.getElementById('game-conclusion').style.display = 'block';
            // set detailed message
            const overall = `Dari permainan ini, kamu mempelajari pola rumus alkana, pemilihan rantai utama dan penomoran cabang. Skor akhir: ${totalCorrect}/${gameQuestions.length}.`;
            document.getElementById('conclusion-text').innerHTML = overall;
            // award badge if score high
            const badgeThreshold = Math.ceil(gameQuestions.length * 0.7); // 70%
            if (totalCorrect >= badgeThreshold) {
                burstConfetti(); playTone(1000, 0.15, 0.02);
                // store badge
                const badges = JSON.parse(localStorage.getItem('alkana_badges') || '[]');
                if (!badges.includes('alkana_star')) { badges.push('alkana_star'); localStorage.setItem('alkana_badges', JSON.stringify(badges)); }
                const badgeMsg = document.createElement('div'); badgeMsg.innerHTML = '<strong>Selamat!</strong> Kamu mendapatkan lencana <em>Eksplorator Alkana</em>.'; badgeMsg.style.marginTop='10px';
                document.getElementById('game-conclusion').appendChild(badgeMsg);
            }
        }

        function nextRound() {
            document.getElementById('game-round-1').style.display = 'none';
            document.getElementById('game-round-2').style.display = 'block';
            document.getElementById('current-round').textContent = '2';
            document.getElementById('game-progress').style.width = '66%';
            
            // Reset seleksi
            const options = document.querySelectorAll('#game-round-2 .game-option');
            options.forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect');
            });
            
            document.getElementById('check-answer-2').style.display = 'block';
            document.getElementById('next-round-2').style.display = 'none';
        }

        function nextRound2() {
            document.getElementById('game-round-2').style.display = 'none';
            document.getElementById('game-round-3').style.display = 'block';
            document.getElementById('current-round').textContent = '3';
            document.getElementById('game-progress').style.width = '100%';
            
            // Reset seleksi
            const options = document.querySelectorAll('#game-round-3 .game-option');
            options.forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect');
            });
            
            document.getElementById('check-answer-3').style.display = 'block';
            document.getElementById('show-results').style.display = 'none';
        }

        function showResults() {
            document.getElementById('game-round-3').style.display = 'none';
            document.getElementById('game-conclusion').style.display = 'block';
            document.getElementById('final-score').textContent = gameScore;
            
            // Tampilkan kesimpulan berdasarkan skor
            let conclusion = "Dari permainan ini, kamu telah belajar bahwa alkana memiliki pola rumus umum <strong>C<sub>n</sub>H<sub>2n+2</sub></strong> ";
            conclusion += "dan penomoran dimulai dari ujung yang paling dekat dengan cabang. ";
            
            if (gameScore === 3) {
                conclusion += "<strong>Luar biasa! Kamu benar-benar menguasai materi alkana!</strong>";
            } else if (gameScore === 2) {
                conclusion += "<strong>Bagus! Hanya sedikit lagi untuk menguasai alkana sepenuhnya!</strong>";
            } else {
                conclusion += "<strong>Terus berlatih! Kamu pasti bisa menguasai alkana dengan lebih baik!</strong>";
            }
            
            document.getElementById('conclusion-text').innerHTML = conclusion;
        }

        // Event listener untuk opsi permainan
        document.addEventListener('DOMContentLoaded', function() {
            const gameOptions = document.querySelectorAll('.game-option');
            gameOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Hapus seleksi dari opsi lain dalam container yang sama
                    const parent = this.parentElement;
                    const siblings = parent.querySelectorAll('.game-option');
                    siblings.forEach(sib => sib.classList.remove('selected'));
                    
                    // Tandai opsi ini sebagai terpilih
                    this.classList.add('selected');
                });
            });
        });

        // --- Preset buttons & atom info / confetti / melody ---
        // Simple confetti (DOM canvas)
        const confettiCanvas = document.createElement('canvas');
        confettiCanvas.id = 'confetti-canvas';
        document.body.appendChild(confettiCanvas);
        const confCtx = confettiCanvas.getContext && confettiCanvas.getContext('2d');
        function resizeConfetti() { confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeConfetti);
        resizeConfetti();

        function burstConfetti() {
            if (!confCtx) return;
            const colors = ['#ff6b6b','#ffd54f','#4a9cff','#7cffb2','#c77cff'];
            const pieces = [];
            for (let i=0;i<80;i++) {
                pieces.push({x: Math.random()*confettiCanvas.width, y: -10, vx: (Math.random()-0.5)*6, vy: Math.random()*4+2, color: colors[Math.floor(Math.random()*colors.length)], life: Math.random()*80+60});
            }
            let frame = 0;
            const id = setInterval(()=>{
                confCtx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
                for (let p of pieces) {
                    p.x += p.vx; p.y += p.vy; p.vy += 0.12; p.life--; confCtx.fillStyle = p.color; confCtx.fillRect(p.x,p.y,6,10);
                }
                frame++; if (frame>180) { clearInterval(id); confCtx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height); }
            }, 16);
        }

        // Simple melody using WebAudio API
        let audioCtx = null;
        let melodyOn = false;
        function toggleMelody() {
            melodyOn = !melodyOn;
            const btn = document.getElementById('toggle-melody');
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (melodyOn) {
                btn.textContent = 'Melodi: ON';
                playMelodyShort();
            } else {
                btn.textContent = 'Melodi: OFF';
            }
        }

        function playMelodyShort() {
            if (!audioCtx) return;
            const notes = [440, 494, 523, 587];
            let t = audioCtx.currentTime;
            for (let i=0;i<notes.length;i++) {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = 'sine'; o.frequency.setValueAtTime(notes[i], t + i*0.18);
                g.gain.setValueAtTime(0.0001, t + i*0.18);
                g.gain.exponentialRampToValueAtTime(0.12, t + i*0.18 + 0.02);
                g.gain.exponentialRampToValueAtTime(0.0001, t + i*0.18 + 0.18);
                o.connect(g); g.connect(audioCtx.destination);
                o.start(t + i*0.18); o.stop(t + i*0.18 + 0.19);
            }
        }

        // Preset handlers
        document.getElementById('preset-methane').addEventListener('click', ()=>{ currentCarbonCount = 1; createMolecule(1); updateAlkaneInfo(1); });
        document.getElementById('preset-pentane').addEventListener('click', ()=>{ currentCarbonCount = 5; createMolecule(5); updateAlkaneInfo(5); });
        document.getElementById('preset-2methylbutane').addEventListener('click', ()=>{ currentCarbonCount = 4; createMolecule(4, [{pos:2,type:'metil'}]); updateAlkaneInfo(4); });
        document.getElementById('preset-2,3-dimethylpentane').addEventListener('click', ()=>{ currentCarbonCount = 5; createMolecule(5, [{pos:2,type:'metil'},{pos:3,type:'metil'}]); updateAlkaneInfo(5); });
        document.getElementById('toggle-melody').addEventListener('click', toggleMelody);

        // Atom click pin: show info
        function onAtomClicked(intersect) {
            const obj = intersect.object;
            if (!obj || !obj.userData) return;
            const info = document.getElementById('atom-info-text');
            if (!info) return;
            const label = obj.userData.label || (obj.material && obj.material.color ? (obj.material.color.equals(new THREE.Color(0x333333)) ? 'C' : 'H') : 'Atom');
            let text = `Anda mengklik: ${label}`;
            if (/C/.test(label)) text += ' ‚Äî Karbon (C). CH‚ÇÉ = 3 H, CH‚ÇÇ = 2 H, CH‚ÇÑ = 4 H.';
            else text += ' ‚Äî Hidrogen (H).'
            info.textContent = text;
            // playful effects
            burstConfetti(); if (melodyOn) playMelodyShort();
        }

        // detect click on atoms in renderer
        renderer && renderer.domElement && renderer.domElement.addEventListener('mousedown', function(ev) {
            const rect = renderer.domElement.getBoundingClientRect();
            const x = ((ev.clientX - rect.left) / rect.width) * 2 - 1;
            const y = -((ev.clientY - rect.top) / rect.height) * 2 + 1;
            const v = new THREE.Vector2(x,y);
            const rc = new THREE.Raycaster(); rc.setFromCamera(v, camera);
            const ints = rc.intersectObjects(atomMeshes, true);
            if (ints && ints.length>0) onAtomClicked(ints[0]);
        });

        // Discovery / prediction helpers
        function normalizeText(s) {
            return (s||'').toString().toLowerCase().replace(/[^a-z0-9]+/g,'').trim();
        }

        function revealNextHint(questionEl, q) {
            if (!questionEl) return;
            questionEl._hintStage = (questionEl._hintStage || 0) + 1;
            const stage = questionEl._hintStage;
            const hintBox = questionEl.querySelector('.hint-box');
            let text = '';

            if (stage === 1) {
                text = 'Cobalah amati: setiap kali atom C bertambah, berapa banyak atom H yang ikut bertambah?';
            } else if (stage === 2) {
                const m = q.prompt && q.prompt.match(/(\d+) atom C/);
                if (m) text = 'Perhatikan: molekul ini memiliki ' + m[1] + ' atom karbon.';
                else text = q.hint || 'Perhatikan posisi cabang dan nomor atom.';
            } else if (stage === 3) {
                // reveal a small clue about the answer
                const ans = q.answer || '';
                const letters = ans.replace(/[^a-z0-9\s]/gi,'').split(' ');
                text = 'Petunjuk kecil: kata kunci ‚Äî "' + (letters[0] ? letters[0].slice(0,3) + '...' : ans) + '"';
            } else {
                text = q.hint || 'Tidak ada petunjuk lebih lanjut. Coba observasi struktur 3D untuk insight.';
            }

            if (hintBox) {
                hintBox.style.display = 'block';
                hintBox.textContent = text;
                hintBox.animate([{opacity:0, transform:'translateY(-6px)'},{opacity:1, transform:'translateY(0)'}], {duration:240, easing:'ease-out'});
            } else {
                // fallback toast
                try { Swal.fire({ toast:true, position:'top-end', icon:'info', title: text, showConfirmButton:false, timer:2000 }); } catch(e) {}
            }
        }

        function testPrediction(qIndex, predInput, questionEl) {
            const q = gameQuestions[qIndex];
            if (!q) return;
            const val = (predInput && predInput.value) ? predInput.value.trim() : '';
            if (!val) {
                try { Swal.fire({ toast:true, position:'top-end', icon:'warning', title:'Tolong isi tebakanmu', showConfirmButton:false, timer:1000 }); } catch(e) {}
                return;
            }
            const norm = normalizeText(val);
            const correctNorm = normalizeText(q.answer);
            questionEl._predAttempts = (questionEl._predAttempts || 0) + 1;

            if (norm === correctNorm) {
                // mark correct: find matching option and simulate check
                const options = questionEl.querySelectorAll('.game-option');
                options.forEach(opt => {
                    if (normalizeText(opt.textContent) === correctNorm) {
                        opt.classList.add('selected');
                    }
                });
                const checkBtn = questionEl.querySelector('.game-controls .game-btn');
                try { checkQuestionAnswer({ currentTarget: checkBtn }); } catch (e) { /* fallback */ }
                // reward curiosity points
                const ptsEl = document.getElementById('points');
                if (ptsEl) ptsEl.textContent = Number(ptsEl.textContent||0) + 5;
                try { Swal.fire({ toast:true, position:'top-end', icon:'success', title:'Tebakan benar! +5 poin', showConfirmButton:false, timer:1200 }); } catch(e) {}
            } else {
                // provide gentle feedback and encourage exploration
                try { Swal.fire({ toast:true, position:'top-end', icon:'info', title:'Belum tepat ‚Äî coba lagi atau minta hint', showConfirmButton:false, timer:1400 }); } catch(e) {}
                // after 2 failed attempts, auto reveal next hint
                if (questionEl._predAttempts >= 2) revealNextHint(questionEl, q);
            }
        }

        function openMysteryBox() {
            // pick a random question to turn into a mini-challenge
            const idx = Math.floor(Math.random() * gameQuestions.length);
            const q = gameQuestions[idx];
            const svg = generate2DDiagramForQuestion(q);
            const wrapper = document.createElement('div');
            wrapper.style.textAlign = 'center';
            svg.setAttribute('width','260'); svg.setAttribute('height','120');
            wrapper.appendChild(svg);
            wrapper.innerHTML += '<p style="color:#fff; margin-top:8px;">Kotak Misteri: Tebak nama senyawa berdasarkan diagram ini.</p>';
            wrapper.innerHTML += '<input id="mystery-input" class="prediction-input" placeholder="Tulis tebakanmu...">';

            Swal.fire({
                title: 'Kotak Misteri',
                html: wrapper.outerHTML,
                showCancelButton: true,
                confirmButtonText: 'Uji Tebakan',
                cancelButtonText: 'Batal',
                preConfirm: () => {
                    const v = document.getElementById('mystery-input') && document.getElementById('mystery-input').value;
                    return v;
                }
            }).then(result => {
                if (result.isConfirmed) {
                    const guess = result.value || '';
                    if (normalizeText(guess) === normalizeText(q.answer)) {
                        burstConfetti(); playTone(900,0.12,0.02);
                        // award badge
                        const badges = JSON.parse(localStorage.getItem('alkana_badges') || '[]');
                        if (!badges.includes('mystery_master')) { badges.push('mystery_master'); localStorage.setItem('alkana_badges', JSON.stringify(badges)); }
                        const ptsEl = document.getElementById('points'); if (ptsEl) ptsEl.textContent = Number(ptsEl.textContent||0) + 10;
                        Swal.fire({ icon:'success', title:'Hebat!', text:'Tebakan benar ‚Äî kamu mendapatkan +10 poin dan lencana Mystery Master.' });
                    } else {
                        Swal.fire({ icon:'error', title:'Belum Tepat', text: 'Coba amati diagram 3D atau minta hint dari soal terkait.' });
                    }
                }
            });
        }

        // Achievement & Investigation (discovery learning) helpers
        const achievements = {
            'first-observation': { title: 'Pengamat Pemula', unlocked: false },
            'pattern-finder': { title: 'Pencari Pola', unlocked: false },
            'molecule-master': { title: 'Ahli Molekul', unlocked: false },
            'formula-discoverer': { title: 'Penemu Rumus', unlocked: false }
        };

        function unlockAchievement(id) {
            if (!achievements[id] || achievements[id].unlocked) return;
            achievements[id].unlocked = true;
            // show toast
            try { Swal.fire({ toast:true, position:'top-end', icon:'success', title:`Pencapaian: ${achievements[id].title}`, showConfirmButton:false, timer:1800 }); } catch(e) {}
            // visual: add to badges area
            const badges = document.getElementById('badges');
            if (badges) {
                const el = document.createElement('div'); el.className = 'achievement'; el.textContent = achievements[id].title; el.style.marginTop='6px'; el.style.fontSize='0.85rem'; badges.appendChild(el);
            }
        }

        let investigationLog = [];

        function startInvestigation() {
            const panel = document.getElementById('investigation-panel');
            if (!panel) return;
            const isVisible = panel.style.display === 'block';
            panel.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                // focus the molecule viewer to encourage exploration
                document.getElementById('intro').scrollIntoView({behavior:'smooth'});
                try { Swal.fire({ toast:true, position:'top-end', icon:'info', title:'Mode investigasi aktif ‚Äî coba tambahkan atau kurangi atom C lalu catat pengamatan!', showConfirmButton:false, timer:2200 }); } catch(e) {}
            }
        }

        function recordObservation() {
            const panel = document.getElementById('investigation-panel');
            if (!panel) return;
            const n = Number(currentCarbonCount || 1);
            // try to get molecular formula text, but compute H conservatively so students discover pattern
            const formula = (document.getElementById('molecular-formula') && document.getElementById('molecular-formula').textContent) || '';
            const expectedH = 2 * n + 2; // used internally for observations (discovery-driven)
            const time = new Date().toLocaleTimeString();
            const obs = { n, H: expectedH, formula, time, note: '' };
            investigationLog.push(obs);
            renderObservations();
            // reward small curiosity points
            const ptsEl = document.getElementById('points'); if (ptsEl) ptsEl.textContent = Number(ptsEl.textContent||0) + 1;
            try { Swal.fire({ toast:true, position:'top-end', icon:'success', title:`Pengamatan dicatat (C=${n}) +1 poin`, showConfirmButton:false, timer:1200 }); } catch(e) {}
        }

        function renderObservations() {
            const tbody = document.getElementById('observation-data');
            const insights = document.getElementById('data-insights');
            const researchProgress = document.getElementById('research-progress');
            if (!tbody) return;
            if (investigationLog.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="padding:12px; text-align:center; color:#aaa">Belum ada pengamatan. Gunakan tombol "Catat Data" setelah mengubah molekul.</td></tr>';
                if (insights) { insights.style.display = 'block'; document.getElementById('current-insight').textContent = 'Mulai catat data untuk melihat pola.'; }
                if (researchProgress) researchProgress.style.width = '0%';
                return;
            }

            tbody.innerHTML = investigationLog.map((o, idx) => {
                let change = '-';
                if (idx > 0) {
                    const prev = investigationLog[idx-1];
                    const deltaC = o.n - prev.n;
                    const deltaH = o.H - prev.H;
                    change = `ŒîC:${deltaC}, ŒîH:${deltaH}`;
                }
                return `
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.04);">
                        <td style="padding:8px; text-align:center">${o.n}</td>
                        <td style="padding:8px; text-align:center">${o.H}</td>
                        <td style="padding:8px; text-align:center">${change}</td>
                        <td style="padding:8px; text-align:center">${o.note || ''}</td>
                    </tr>
                `;
            }).join('');

            // Compute quick insight: check deltas
            const deltas = [];
            for (let i = 1; i < investigationLog.length; i++) {
                deltas.push({ deltaC: investigationLog[i].n - investigationLog[i-1].n, deltaH: investigationLog[i].H - investigationLog[i-1].H });
            }
            let insightText = 'Tambahkan lebih banyak data untuk menemukan pola.';
            if (deltas.length > 0) {
                const consistent = deltas.every(d => d.deltaH === 2 * d.deltaC);
                if (consistent) insightText = 'Insight: Tampak konsisten bahwa setiap +1 C berkaitan dengan +2 H.';
                else insightText = 'Insight: Perubahan tidak sepenuhnya konsisten; perhatikan perubahan tiap percobaan.';
            }
            if (insights) { insights.style.display = 'block'; document.getElementById('current-insight').textContent = insightText; }

            // Update progress bar (simple heuristic)
            const progressPercent = Math.min(100, investigationLog.length * 20);
            if (researchProgress) researchProgress.style.width = progressPercent + '%';

            // Unlock pattern achievement if consistent pattern found
            if (deltas.length >= 2 && deltas.every(d => d.deltaH === 2 * d.deltaC)) {
                try { unlockAchievement && unlockAchievement('pattern-finder'); } catch(e) {}
            }
        }

        function suggestPattern() {
            if (investigationLog.length === 0) {
                try { Swal.fire({ icon:'info', title:'Catat beberapa pengamatan dulu', text: 'Cobalah mencatat 3-4 pengamatan dengan jumlah atom C berbeda sebelum meminta pola.' }); } catch(e) {}
                return;
            }
            // check if observations fit H = 2n + 2
            let fits = true;
            for (let o of investigationLog) {
                const n = Number(o.n);
                const expectedH = 2*n + 2;
                // we don't trust parsing H from formula reliably (subscripts), so compare with expected
                // if molecular-formula contains digits for H, try to parse, else assume expected
                const f = o.formula || '';
                const m = f.match(/H[_¬¢‚ÇÄ‚ÇÅ‚ÇÇ‚ÇÉ‚ÇÑ‚ÇÖ‚ÇÜ‚Çá‚Çà‚Çâ0-9]+/i);
                if (m) {
                    // extract numbers
                    const digits = f.replace(/[^0-9]/g,'');
                    if (digits.length>0) {
                        // crude: take last two digits as H (works for <=99)
                        const h = Number(digits.slice(-2));
                        if (!isNaN(h) && h !== expectedH) { fits = false; break; }
                    }
                }
            }

            if (fits) {
                const suggestion = `Berdasarkan pengamatan(${investigationLog.length}), terlihat pola konsisten antara perubahan jumlah C dan perubahan H. Coba tuliskan hipotesismu tentang bagaimana ŒîH terkait ŒîC (mis. setiap +1 C biasanya diikuti perubahan tertentu pada H).`;
                try { Swal.fire({ title:'Saran Pola', html:`<p>${suggestion}</p><p style="font-size:0.95rem;">Ingin saya masukkan simpulan ini ke bagian Refleksi untuk dikembangkan?</p>`, showCancelButton:true }).then(res=>{ if (res.isConfirmed) { document.querySelector('#reflection .reflection-input') && (document.querySelector('#reflection .reflection-input').value = suggestion); try{ Swal.fire({ toast:true, position:'top-end', icon:'success', title:'Simpulan sementara dimasukkan ke refleksi', showConfirmButton:false, timer:1400 }); }catch(e){} } }); } catch(e) { alert(suggestion); }
            } else {
                try { Swal.fire({ icon:'question', title:'Pola tidak konsisten', text:'Beberapa pengamatan belum sesuai pola sederhana; coba catat lebih banyak atau perhatikan posisi atom H pada tiap C.' }); } catch(e) {}
            }
        }

        // Prediction & Theory helpers
        function openPredictionPrompt() {
            // ask student to enter a prediction for a chosen carbon count
            const c = Math.max(2, Math.floor(Math.random() * 6) + 2); // random between 2..7
            Swal.fire({
                title: `Prediksi: Jika jumlah C = ${c}`,
                html: `Berdasarkan pengamatanmu, berapa jumlah atom H?`,
                input: 'number',
                inputAttributes: { min: 0 },
                showCancelButton: true,
                confirmButtonText: 'Cek Prediksi'
            }).then(res => {
                if (res.isConfirmed) {
                    const val = Number(res.value);
                    const expected = 2 * c + 2;
                    if (val === expected) {
                        unlockAchievement('molecule-master');
                        Swal.fire({ icon:'success', title:'Prediksi Tepat!', text:`Benar ‚Äî jumlah H = ${expected}.` });
                    } else {
                        Swal.fire({ icon:'info', title:'Coba Lagi', html:`Prediksimu: ${val}<br>Perhatikan kembali tabel pengamatan dan hubungan yang muncul.` });
                    }
                }
            });
        }

        function submitStudentTheory() {
            const notesEl = document.getElementById('theory-notes');
            const evidenceEl = document.getElementById('theory-evidence');
            const statusEl = document.getElementById('theory-status');
            const notes = notesEl ? notesEl.value.trim() : '';
            const evidence = evidenceEl ? evidenceEl.value.trim() : '';
            if (!notes) { Swal.fire('Perlu Teori', 'Tulis dulu teorimu sebelum mengajukan.', 'warning'); return; }
            if (statusEl) statusEl.textContent = 'Diajukan';
            // simple heuristic to check for correct idea without revealing formula
            const lower = (notes + ' ' + evidence).toLowerCase();
            const correctHints = ['2', 'dua', '+2', 'bertambah 2', 'setiap +1 c', 'per 1 c', 'per carbon'];
            const found = correctHints.some(h => lower.includes(h));
            if (found) {
                unlockAchievement('formula-discoverer');
                if (statusEl) statusEl.textContent = 'Diajukan - Kuat';
                Swal.fire({ icon:'success', title:'Teori Diajukan', text:'Teorimu menunjukkan pemahaman pola ‚Äî bagus!' });
            } else {
                if (statusEl) statusEl.textContent = 'Diajukan - Perlu Bukti';
                Swal.fire({ icon:'info', title:'Teori Diajukan', text:'Terima kasih! Coba tambahkan contoh atau bukti dari jurnal pengamatan.' });
            }
        }

        function openTheoryTest() {
            // quick test: ask a random C and expect H
            const c = Math.max(2, Math.floor(Math.random() * 6) + 2);
            const expected = 2 * c + 2;
            Swal.fire({
                title: `Uji Teori: C = ${c}`,
                input: 'number',
                inputAttributes: { min:0 },
                showCancelButton: true,
                confirmButtonText: 'Periksa'
            }).then(r => {
                if (r.isConfirmed) {
                    const val = Number(r.value);
                    if (val === expected) {
                        unlockAchievement('molecule-master');
                        Swal.fire('Benar!', `H = ${expected}`, 'success');
                    } else {
                        Swal.fire('Belum Tepat', `Coba analisis lagi. Prediksi benar adalah ${expected}`, 'error');
                    }
                }
            });
        }

        function concludeInvestigation() {
            // ask student to write their conclusion and save it to reflection area
            try {
                Swal.fire({
                    title: 'Simpulkan Temuanmu',
                    input: 'textarea',
                    inputPlaceholder: 'Tulis kesimpulan singkat: apa pola yang kamu temukan dan mengapa?',
                    showCancelButton: true,
                    preConfirm: (val) => val
                }).then(res => {
                    if (res.isConfirmed && res.value) {
                        // set to reflection textarea (first one)
                        const refl = document.querySelector('#reflection .reflection-input');
                        if (refl) refl.value = res.value;
                        try { Swal.fire({ icon:'success', title:'Simpulan disimpan', showConfirmButton:false, timer:1200 }); } catch(e) {}
                    }
                });
            } catch(e) {
                const txt = prompt('Tulis kesimpulan singkat:');
                if (txt) { const refl = document.querySelector('#reflection .reflection-input'); if (refl) refl.value = txt; }
            }
        }

        // wire investigation panel buttons after DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            const rec = document.getElementById('record-observation-btn'); if (rec) rec.addEventListener('click', recordObservation);
            const anl = document.getElementById('analyze-pattern-btn'); if (anl) anl.addEventListener('click', suggestPattern);
            const mak = document.getElementById('make-prediction-btn'); if (mak) mak.addEventListener('click', function(){ openPredictionPrompt(); });
            const sub = document.getElementById('submit-theory'); if (sub) sub.addEventListener('click', function(){ submitStudentTheory(); });
            const testr = document.getElementById('test-theory'); if (testr) testr.addEventListener('click', function(){ openTheoryTest(); });
            const con = document.getElementById('conclude-investigation'); if (con) con.addEventListener('click', concludeInvestigation);
        });

        // Inisialisasi aplikasi saat halaman dimuat
        window.onload = init;

        // Keyboard shortcuts
        window.addEventListener('keydown', function(e) {
            if (e.key === 'r' || e.key === 'R') { autoRotate = !autoRotate; }
            if (e.key === 'f' || e.key === 'F') { if (currentMolecule) fitCameraToObject(currentMolecule, camera, controls); }
            if (e.key === 'c' || e.key === 'C') {
                // cycle presets
                const presets = ['preset-methane','preset-pentane','preset-2methylbutane','preset-2,3-dimethylpentane'];
                const active = presets.findIndex(id => document.getElementById(id).classList.contains('active'));
                const next = (active + 1) % presets.length;
                document.getElementById(presets[next]).click();
            }
        });
    </script>
</body>
</html>